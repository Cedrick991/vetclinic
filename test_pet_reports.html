<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pet Reports - Tattao Veterinary Clinic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-section h3 {
            margin-top: 0;
            color: #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pet-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        .pet-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .pet-item:hover {
            background-color: #f0f4ff;
        }
        .pet-item.selected {
            background-color: #e3f2fd;
            border-left: 3px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-medical"></i> Pet Reports Test Interface</h1>
            <p>Test the pet reports functionality</p>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-list"></i> Test Pet List API</h3>
            <button onclick="testGetPetList()">
                <i class="fas fa-list"></i> Get Pet List
            </button>
            <div id="petListResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-search"></i> Search Pets</h3>
            <input type="text" id="searchInput" placeholder="Search pets..." style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px;">
            <button onclick="testSearchPets()">
                <i class="fas fa-search"></i> Search
            </button>
            <div id="searchResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-file-alt"></i> Generate Pet Report</h3>
            <div id="petListContainer" class="pet-list" style="display: none;">
                <div class="loading" id="petListLoading">
                    <div class="spinner"></div>
                    Loading pets...
                </div>
            </div>
            <div id="reportResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-download"></i> Download PDF Report</h3>
            <button onclick="testDownloadPDF()" id="pdfBtn" style="display: none;">
                <i class="fas fa-download"></i> Download PDF
            </button>
            <div id="pdfResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let selectedPetId = null;

        async function testGetPetList() {
            const resultDiv = document.getElementById('petListResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Testing pet list API...</div>';

            try {
                const response = await fetch('api/pet_reports_api.php?action=get_pet_list&limit=10');
                const result = await response.json();

                if (result.success) {
                    resultDiv.classList.add('success');
                    resultDiv.innerHTML = `
                        <strong>✅ Success!</strong><br>
                        Found ${result.data.length} pets:<br>
                        <ul>
                            ${result.data.map(pet => `<li>${pet.name} (${pet.species}) - Owner: ${pet.first_name} ${pet.last_name}</li>`).join('')}
                        </ul>
                    `;

                    // Display pets for selection
                    displayPetsForSelection(result.data);
                } else {
                    resultDiv.classList.add('error');
                    resultDiv.innerHTML = `<strong>❌ Error:</strong> ${result.message}`;
                }
            } catch (error) {
                resultDiv.classList.add('error');
                resultDiv.innerHTML = `<strong>❌ Error:</strong> ${error.message}`;
            }
        }

        async function testSearchPets() {
            const searchTerm = document.getElementById('searchInput').value;
            const resultDiv = document.getElementById('searchResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Searching pets...</div>';

            if (!searchTerm) {
                resultDiv.classList.add('error');
                resultDiv.innerHTML = '<strong>❌ Error:</strong> Please enter a search term';
                return;
            }

            try {
                const response = await fetch(`api/pet_reports_api.php?action=get_pet_list&search=${encodeURIComponent(searchTerm)}&limit=10`);
                const result = await response.json();

                if (result.success) {
                    resultDiv.classList.add('success');
                    resultDiv.innerHTML = `
                        <strong>✅ Search Success!</strong><br>
                        Found ${result.data.length} pets matching "${searchTerm}":<br>
                        <ul>
                            ${result.data.map(pet => `<li>${pet.name} (${pet.species}) - Owner: ${pet.first_name} ${pet.last_name}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    resultDiv.classList.add('error');
                    resultDiv.innerHTML = `<strong>❌ Error:</strong> ${result.message}`;
                }
            } catch (error) {
                resultDiv.classList.add('error');
                resultDiv.innerHTML = `<strong>❌ Error:</strong> ${error.message}`;
            }
        }

        function displayPetsForSelection(pets) {
            const container = document.getElementById('petListContainer');
            const loading = document.getElementById('petListLoading');

            if (pets.length === 0) {
                container.innerHTML = '<div class="loading">No pets found</div>';
                return;
            }

            container.innerHTML = '';
            container.style.display = 'block';

            pets.forEach(pet => {
                const petItem = document.createElement('div');
                petItem.className = 'pet-item';
                petItem.onclick = () => selectPet(pet.id, petItem);

                petItem.innerHTML = `
                    <strong>${pet.name}</strong><br>
                    <small>${pet.species} • ${pet.breed || 'Mixed'} • Owner: ${pet.first_name} ${pet.last_name}</small>
                `;

                container.appendChild(petItem);
            });
        }

        function selectPet(petId, element) {
            selectedPetId = petId;

            // Remove previous selection
            document.querySelectorAll('.pet-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selection to clicked item
            element.classList.add('selected');

            // Show PDF button
            document.getElementById('pdfBtn').style.display = 'inline-block';

            testGetPetReport(petId);
        }

        async function testGetPetReport(petId) {
            const resultDiv = document.getElementById('reportResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Loading pet report...</div>';

            try {
                const response = await fetch(`api/pet_reports_api.php?action=get_pet_report&pet_id=${petId}`);
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    resultDiv.classList.add('success');
                    resultDiv.innerHTML = `
                        <strong>✅ Report Generated Successfully!</strong><br><br>
                        <strong>Pet:</strong> ${data.pet.name} (${data.pet.species})<br>
                        <strong>Owner:</strong> ${data.owner.name}<br>
                        <strong>Total Appointments:</strong> ${data.statistics.total_appointments}<br>
                        <strong>Total Vaccinations:</strong> ${data.statistics.total_vaccinations}<br>
                        <strong>Last Visit:</strong> ${data.statistics.last_visit ? new Date(data.statistics.last_visit).toLocaleDateString() : 'Never'}<br>
                        <strong>Recent Appointments:</strong> ${data.appointments.slice(0, 3).map(a => a.service_name).join(', ')}<br>
                    `;
                } else {
                    resultDiv.classList.add('error');
                    resultDiv.innerHTML = `<strong>❌ Error:</strong> ${result.message}`;
                }
            } catch (error) {
                resultDiv.classList.add('error');
                resultDiv.innerHTML = `<strong>❌ Error:</strong> ${error.message}`;
            }
        }

        async function testDownloadPDF() {
            if (!selectedPetId) {
                alert('Please select a pet first');
                return;
            }

            const resultDiv = document.getElementById('pdfResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Generating PDF...</div>';

            try {
                const response = await fetch(`api/pet_reports_api.php?action=generate_pdf&pet_id=${selectedPetId}`);
                const result = await response.json();

                if (result.success) {
                    // Load jsPDF library if not already loaded
                    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                        await loadJSPDFLibrary();
                    }

                    const { jsPDF } = window.jspdf;

                    // Create new PDF document
                    const pdf = new jsPDF('p', 'mm', 'a4');

                    // Set up fonts and styles
                    pdf.setFont('helvetica');

                    // Add header
                    pdf.setFontSize(20);
                    pdf.setTextColor(40, 40, 40);
                    pdf.text('Tattoo Veterinary Clinic', 105, 20, { align: 'center' });

                    pdf.setFontSize(16);
                    pdf.text('Pet Medical Report', 105, 30, { align: 'center' });

                    // Add clinic info
                    pdf.setFontSize(10);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Clinic Address: Your Clinic Address', 105, 40, { align: 'center' });
                    pdf.text('Phone: 0917-519-4639 | Email: info@tattoovet.com', 105, 45, { align: 'center' });
                    pdf.text(`Generated: ${new Date().toLocaleString()}`, 105, 50, { align: 'center' });

                    let yPosition = 65;

                    // Pet Information Section
                    pdf.setFontSize(14);
                    pdf.setTextColor(40, 40, 40);
                    pdf.text('Pet Information', 20, yPosition);
                    yPosition += 10;

                    pdf.setFontSize(10);
                    pdf.setTextColor(60, 60, 60);

                    const petInfo = [
                        ['Name:', result.data.pet.name],
                        ['Species:', result.data.pet.species],
                        ['Breed:', result.data.pet.breed || 'Not specified'],
                        ['Age:', result.data.pet.age],
                        ['Gender:', result.data.pet.gender || 'Not specified'],
                        ['Weight:', result.data.pet.weight],
                        ['Color:', result.data.pet.color || 'Not specified']
                    ];

                    if (result.data.pet.notes) {
                        petInfo.push(['Notes:', result.data.pet.notes]);
                    }

                    petInfo.forEach(([label, value]) => {
                        pdf.text(`${label} ${value}`, 20, yPosition);
                        yPosition += 6;
                    });

                    // Owner Information Section
                    yPosition += 5;
                    pdf.setFontSize(14);
                    pdf.setTextColor(40, 40, 40);
                    pdf.text('Owner Information', 20, yPosition);
                    yPosition += 10;

                    pdf.setFontSize(10);
                    pdf.setTextColor(60, 60, 60);

                    const ownerInfo = [
                        ['Name:', result.data.owner.name],
                        ['Email:', result.data.owner.email],
                        ['Phone:', result.data.owner.phone || 'Not provided'],
                        ['Address:', result.data.owner.address || 'Not provided']
                    ];

                    ownerInfo.forEach(([label, value]) => {
                        pdf.text(`${label} ${value}`, 20, yPosition);
                        yPosition += 6;
                    });

                    // Statistics Section
                    yPosition += 5;
                    pdf.setFontSize(14);
                    pdf.setTextColor(40, 40, 40);
                    pdf.text('Statistics', 20, yPosition);
                    yPosition += 10;

                    pdf.setFontSize(10);
                    pdf.setTextColor(60, 60, 60);

                    const stats = [
                        ['Total Appointments:', result.data.statistics.total_appointments.toString()],
                        ['Total Vaccinations:', result.data.statistics.total_vaccinations.toString()],
                        ['Last Visit:', result.data.statistics.last_visit ? new Date(result.data.statistics.last_visit).toLocaleDateString() : 'Never']
                    ];

                    stats.forEach(([label, value]) => {
                        pdf.text(`${label} ${value}`, 20, yPosition);
                        yPosition += 6;
                    });

                    // Appointment History Section
                    if (result.data.appointments.length > 0) {
                        yPosition += 5;
                        pdf.setFontSize(14);
                        pdf.setTextColor(40, 40, 40);
                        pdf.text('Recent Appointments', 20, yPosition);
                        yPosition += 10;

                        pdf.setFontSize(9);
                        pdf.setTextColor(60, 60, 60);

                        // Table header
                        pdf.text('Date', 20, yPosition);
                        pdf.text('Service', 60, yPosition);
                        pdf.text('Staff', 120, yPosition);
                        pdf.text('Status', 160, yPosition);
                        yPosition += 6;

                        // Table rows
                        result.data.appointments.slice(0, 10).forEach(appointment => {
                            if (yPosition > 270) { // New page if needed
                                pdf.addPage();
                                yPosition = 20;
                            }

                            const date = new Date(appointment.appointment_date).toLocaleDateString();
                            const service = appointment.service_name.length > 25 ? appointment.service_name.substring(0, 22) + '...' : appointment.service_name;
                            const staff = appointment.staff_first_name ? `${appointment.staff_first_name} ${appointment.staff_last_name || ''}` : 'Not assigned';
                            const staffName = staff.length > 20 ? staff.substring(0, 17) + '...' : staff;

                            pdf.text(date, 20, yPosition);
                            pdf.text(service, 60, yPosition);
                            pdf.text(staffName, 120, yPosition);
                            pdf.text(appointment.status, 160, yPosition);
                            yPosition += 6;
                        });
                    }

                    // Add footer
                    const pageCount = pdf.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(8);
                        pdf.setTextColor(150, 150, 150);
                        pdf.text(`Page ${i} of ${pageCount}`, 105, 285, { align: 'center' });
                        pdf.text('This report contains confidential medical information.', 105, 290, { align: 'center' });
                    }

                    // Generate filename
                    const filename = `pet_report_${result.data.pet.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;

                    // Download the PDF
                    pdf.save(filename);

                    resultDiv.classList.add('success');
                    resultDiv.innerHTML = `
                        <strong>✅ PDF Downloaded Successfully!</strong><br><br>
                        <p>The PDF report has been generated and downloaded using client-side PDF generation.</p>
                        <p><strong>Filename:</strong> ${filename}</p>
                        <p><strong>Pet:</strong> ${result.data.pet.name}</p>
                        <p><strong>Appointments:</strong> ${result.data.statistics.total_appointments}</p>
                    `;
                } else {
                    resultDiv.classList.add('error');
                    resultDiv.innerHTML = `<strong>❌ Error:</strong> ${result.message}`;
                }
            } catch (error) {
                resultDiv.classList.add('error');
                resultDiv.innerHTML = `<strong>❌ Error:</strong> ${error.message}`;
            }
        }

        async function loadJSPDFLibrary() {
            return new Promise((resolve, reject) => {
                // Check if already loaded
                if (typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    // Wait a bit for the library to initialize
                    setTimeout(() => {
                        if (typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('jsPDF library failed to load properly'));
                        }
                    }, 100);
                };
                script.onerror = () => reject(new Error('Failed to load jsPDF library'));
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>