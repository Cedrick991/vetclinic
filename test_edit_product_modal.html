<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Edit Product Modal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        .close {
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }
        .close:hover {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .test-button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>Test Edit Product Modal Functionality</h1>

    <button class="test-button" onclick="testModalOpen()">Test Open Modal</button>
    <button class="test-button" onclick="testModalClose()">Test Close Modal</button>
    <button class="test-button" onclick="testFormSubmission()">Test Form Submission</button>

    <div class="test-results" id="testResults">
        <h3>Test Results:</h3>
        <div id="results"></div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Product</h3>
                <span class="close" onclick="closeEditProductModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProductForm" class="booking-form">
                    <input type="hidden" id="editProductId" name="editProductId" value="1">
                    <div class="form-group">
                        <label for="editProductName">Product Name *</label>
                        <input type="text" id="editProductName" name="editProductName" value="Test Product" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductCategory">Category *</label>
                        <select id="editProductCategory" name="editProductCategory" required>
                            <option value="">Select Category</option>
                            <option value="Food" selected>Food</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editProductDescription">Description</label>
                        <textarea id="editProductDescription" name="editProductDescription" rows="3">Test product description</textarea>
                    </div>
                    <div class="form-group">
                        <label for="editProductPrice">Price *</label>
                        <input type="number" id="editProductPrice" name="editProductPrice" value="25.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductStock">Stock</label>
                        <input type="number" id="editProductStock" name="editProductStock" value="100">
                    </div>
                    <div class="form-group">
                        <label for="editProductStatus">Status</label>
                        <select id="editProductStatus" name="editProductStatus">
                            <option value="1" selected>Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditProductModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Mock StaffDashboard class for testing
        class MockStaffDashboard {
            showToast(message, type = 'info') {
                this.logResult(`Toast: ${type} - ${message}`);
            }

            logResult(message) {
                const results = document.getElementById('results');
                const div = document.createElement('div');
                div.className = 'info';
                div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                results.appendChild(div);
                results.scrollTop = results.scrollHeight;
            }

            closeEditProductModal() {
                console.log('🔄 Closing edit product modal...');

                const modal = document.getElementById('editProductModal');
                if (modal) {
                    console.log('✅ Found edit product modal, hiding it');
                    modal.style.display = 'none';
                    document.body.style.overflow = ''; // Restore scrolling

                    // Clear form data
                    const form = document.getElementById('editProductForm');
                    if (form) {
                        console.log('✅ Clearing form data');
                        form.reset();

                        // Clear any image preview
                        const preview = document.getElementById('editProductImagePreview');
                        if (preview) {
                            console.log('✅ Clearing image preview');
                            preview.style.display = 'none';
                            preview.src = '';
                        }

                        // Clear file input
                        const fileInput = document.getElementById('editProductImageInput');
                        if (fileInput) {
                            fileInput.value = '';
                        }
                    }

                    console.log('✅ Edit product modal closed successfully');
                    this.showToast('Edit cancelled', 'info');
                } else {
                    console.error('❌ Edit product modal not found');
                    this.logResult('ERROR: Edit product modal not found');
                }
            }

            async submitProduct(productData, action) {
                this.logResult(`Submitting ${action} product: ${productData.name}`);
                this.logResult(`Product data: ${JSON.stringify(productData, null, 2)}`);

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Simulate success
                this.showToast(`Product ${action}ed successfully!`, 'success');
                this.closeEditProductModal();
                this.logResult(`Product ${action} completed successfully`);
            }

            async handleEditProduct(form) {
                try {
                    const formData = new FormData(form);

                    // Validate required fields
                    if (!formData.get('editProductName') || !formData.get('editProductPrice') || !formData.get('editProductCategory')) {
                        this.showToast('Please fill in all required fields', 'error');
                        this.logResult('ERROR: Missing required fields');
                        return;
                    }

                    const productData = {
                        action: 'update_product',
                        product_id: parseInt(formData.get('editProductId')),
                        name: formData.get('editProductName'),
                        category: formData.get('editProductCategory'),
                        description: formData.get('editProductDescription'),
                        price: parseFloat(formData.get('editProductPrice')),
                        stock: parseInt(formData.get('editProductStock')) || 0,
                        is_active: formData.get('editProductStatus') === '1' ? 1 : 0
                    };

                    this.logResult('Form validation passed, submitting product...');
                    await this.submitProduct(productData, 'edit');
                } catch (error) {
                    console.error('Edit product error:', error);
                    this.showToast('Failed to update product. Please try again.', 'error');
                    this.logResult(`ERROR: ${error.message}`);
                }
            }
        }

        // Initialize mock dashboard
        const mockDashboard = new MockStaffDashboard();

        // Test functions
        function testModalOpen() {
            mockDashboard.logResult('Testing modal open...');
            const modal = document.getElementById('editProductModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            mockDashboard.logResult('Modal opened successfully');
        }

        function testModalClose() {
            mockDashboard.logResult('Testing modal close...');
            mockDashboard.closeEditProductModal();
        }

        function testFormSubmission() {
            mockDashboard.logResult('Testing form submission...');

            const form = document.getElementById('editProductForm');
            if (form) {
                // Add event listener temporarily
                const submitHandler = async (e) => {
                    e.preventDefault();
                    await mockDashboard.handleEditProduct(form);
                    form.removeEventListener('submit', submitHandler);
                };
                form.addEventListener('submit', submitHandler);

                // Trigger form submission
                form.dispatchEvent(new Event('submit'));
            } else {
                mockDashboard.logResult('ERROR: Form not found');
            }
        }

        // Global function to close edit product modal
        function closeEditProductModal() {
            if (mockDashboard && mockDashboard.closeEditProductModal) {
                mockDashboard.closeEditProductModal();
            } else {
                console.error('MockDashboard not available, using fallback');
                // Fallback implementation
                const modal = document.getElementById('editProductModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = ''; // Restore scrolling

                    // Clear form data
                    const form = document.getElementById('editProductForm');
                    if (form) {
                        form.reset();
                        const preview = document.getElementById('editProductImagePreview');
                        if (preview) {
                            preview.style.display = 'none';
                            preview.src = '';
                        }
                    }
                }
            }
        }

        // Add form submission handler
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('editProductForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await mockDashboard.handleEditProduct(form);
                });
            }
        });
    </script>
</body>
</html>