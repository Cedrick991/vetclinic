<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Tattoo Veterinary Clinic</title>
  <link rel="stylesheet" href="../assets/css/modern-dashboard.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Admin-specific styling */
    .sidebar {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    .admin-badge {
      background: #ff6b6b;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .danger-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    .danger-btn:hover {
      background: #c0392b;
    }
    .warning-btn {
      background: #f39c12;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    .success-btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    .admin-table th,
    .admin-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }
    .admin-table th {
      background: rgba(0, 0, 0, 0.2);
      font-weight: 600;
    }
    .admin-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    .status-active {
      color: #27ae60;
      font-weight: bold;
    }
    .status-inactive {
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="../assets/images/logoo.jpg" alt="Admin Avatar">
        <h3 id="adminName">System Admin</h3>
        <p>Administrator <span class="admin-badge">ADMIN</span></p>
      </div>
      
      <div class="sidebar-nav">
        <a href="#dashboard" class="nav-item active" onclick="showSection('dashboard')">
          <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
        </a>
        <a href="#users" class="nav-item" onclick="showSection('users')">
          <i class="fas fa-users"></i> <span>User Management</span>
        </a>
        <a href="#appointments" class="nav-item" onclick="showSection('appointments')">
          <i class="fas fa-calendar-alt"></i> <span>Appointments</span>
        </a>
        <a href="#pets" class="nav-item" onclick="showSection('pets')">
          <i class="fas fa-paw"></i> <span>Pet Registry</span>
        </a>
        <a href="#staff" class="nav-item" onclick="showSection('staff')">
          <i class="fas fa-user-md"></i> <span>Staff Management</span>
        </a>
        <a href="#database" class="nav-item" onclick="showSection('database')">
          <i class="fas fa-database"></i> <span>Database Tools</span>
        </a>
        <a href="#" class="nav-item" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
        </a>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
      
      <!-- Header Bar -->
      <header class="header-bar">
        <div class="header-title">
          <h1 id="pageTitle"><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
        </div>
        <div class="header-actions">
          <button class="header-btn" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </header>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        
        <!-- Welcome Section -->
        <div class="welcome-section">
          <h2 class="welcome-title">
            <i class="fas fa-shield-alt"></i> Administrator Control Panel
          </h2>
          <p class="welcome-subtitle">Full database management and system administration</p>
        </div>

        <!-- Dashboard Section -->
        <section id="dashboardSection" class="content-section" style="display: block;">
          <div class="dashboard-grid">
            <div class="dashboard-card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-users"></i> Total Users
                </div>
              </div>
              <div class="card-value" id="totalUsers">0</div>
              <div class="card-subtitle">Clients + Staff</div>
            </div>
            
            <div class="dashboard-card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-calendar-alt"></i> Appointments
                </div>
              </div>
              <div class="card-value" id="totalAppointments">0</div>
              <div class="card-subtitle">All appointments</div>
            </div>
            
            <div class="dashboard-card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-paw"></i> Registered Pets
                </div>
              </div>
              <div class="card-value" id="totalPets">0</div>
              <div class="card-subtitle">Active pets</div>
            </div>
            
            <div class="dashboard-card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-user-md"></i> Staff Members
                </div>
              </div>
              <div class="card-value" id="totalStaff">0</div>
              <div class="card-subtitle">Active staff</div>
            </div>
          </div>
        </section>

        <!-- User Management Section -->
        <section id="usersSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-users"></i> User Management
            </h2>
            <button class="header-btn" onclick="loadUsers()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div id="usersContent">
            <div class="loading">Loading users...</div>
          </div>
        </section>

        <!-- Appointments Section -->
        <section id="appointmentsSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-calendar-alt"></i> All Appointments
            </h2>
            <button class="header-btn" onclick="loadAppointments()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div id="appointmentsContent">
            <div class="loading">Loading appointments...</div>
          </div>
        </section>

        <!-- Pets Section -->
        <section id="petsSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-paw"></i> Pet Registry
            </h2>
            <button class="header-btn" onclick="loadPets()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div id="petsContent">
            <div class="loading">Loading pets...</div>
          </div>
        </section>

        <!-- Staff Section -->
        <section id="staffSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-user-md"></i> Staff Management
            </h2>
            <button class="header-btn" onclick="loadStaff()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div id="staffContent">
            <div class="loading">Loading staff...</div>
          </div>
        </section>

        <!-- Database Tools Section -->
        <section id="databaseSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-database"></i> Database Management Tools
            </h2>
          </div>
          <div class="dashboard-grid">
            <div class="dashboard-card">
              <h3>‚ö†Ô∏è Danger Zone</h3>
              <p>These actions cannot be undone!</p>
              <button class="danger-btn" onclick="resetDatabase()">
                <i class="fas fa-trash"></i> Reset Database
              </button>
              <button class="danger-btn" onclick="deleteAllUsers()">
                <i class="fas fa-users"></i> Delete All Users
              </button>
              <button class="danger-btn" onclick="deleteAllAppointments()">
                <i class="fas fa-calendar"></i> Delete All Appointments
              </button>
            </div>
            <div class="dashboard-card">
              <h3>üîß Maintenance</h3>
              <p>Database maintenance tools</p>
              <button class="warning-btn" onclick="backupDatabase()">
                <i class="fas fa-download"></i> Backup Database
              </button>
              <button class="success-btn" onclick="optimizeDatabase()">
                <i class="fas fa-cogs"></i> Optimize Database
              </button>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Global variables
    let currentSection = 'dashboard';

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      checkAdminAuth();
      loadDashboardStats();
    });

    // Check admin authentication
    function checkAdminAuth() {
      // For now, we'll assume the user is authenticated
      // In production, you'd check session/token here
      console.log('Admin authenticated');
    }

    // Show section
    function showSection(sectionName) {
      // Hide all sections
      const sections = document.querySelectorAll('.content-section');
      sections.forEach(section => {
        section.style.display = 'none';
      });

      // Remove active class from nav items
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.classList.remove('active');
      });

      // Show selected section
      const targetSection = document.getElementById(sectionName + 'Section');
      if (targetSection) {
        targetSection.style.display = 'block';
      }

      // Add active class to clicked nav item
      const activeNavItem = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
      if (activeNavItem) {
        activeNavItem.classList.add('active');
      }

      // Update page title
      const titles = {
        'dashboard': '<i class="fas fa-shield-alt"></i> Admin Dashboard',
        'users': '<i class="fas fa-users"></i> User Management',
        'appointments': '<i class="fas fa-calendar-alt"></i> Appointments',
        'pets': '<i class="fas fa-paw"></i> Pet Registry',
        'staff': '<i class="fas fa-user-md"></i> Staff Management',
        'database': '<i class="fas fa-database"></i> Database Tools'
      };
      
      const pageTitle = document.getElementById('pageTitle');
      if (pageTitle && titles[sectionName]) {
        pageTitle.innerHTML = titles[sectionName];
      }

      currentSection = sectionName;

      // Load section data
      if (sectionName === 'users') loadUsers();
      else if (sectionName === 'appointments') loadAppointments();
      else if (sectionName === 'pets') loadPets();
      else if (sectionName === 'staff') loadStaff();
    }

    // API call helper
    async function apiCall(action, data = {}) {
      try {
        const formData = new FormData();
        formData.append('action', action);
        
        for (const [key, value] of Object.entries(data)) {
          formData.append(key, value);
        }

        const response = await fetch('admin_api.php', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
      } catch (error) {
        console.error('API Error:', error);
        showToast('Error: ' + error.message, 'error');
        throw error;
      }
    }

    // Load dashboard statistics
    async function loadDashboardStats() {
      try {
        const result = await apiCall('get_admin_statistics');
        if (result.success) {
          document.getElementById('totalUsers').textContent = result.data.total_users || 0;
          document.getElementById('totalAppointments').textContent = result.data.total_appointments || 0;
          document.getElementById('totalPets').textContent = result.data.total_pets || 0;
          document.getElementById('totalStaff').textContent = result.data.total_staff || 0;
        }
      } catch (error) {
        console.error('Failed to load dashboard stats:', error);
      }
    }

    // Load users
    async function loadUsers() {
      const content = document.getElementById('usersContent');
      content.innerHTML = '<div class="loading">Loading users...</div>';

      try {
        const result = await apiCall('get_all_users_admin');
        if (result.success && result.data) {
          let html = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;

          result.data.forEach(user => {
            html += `
              <tr>
                <td>${user.id}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.user_type.toUpperCase()}</td>
                <td class="status-${user.status}">${user.status.toUpperCase()}</td>
                <td>
                  ${user.status === 'active' ? 
                    `<button class="danger-btn" onclick="deactivateUser(${user.id}, '${user.user_type}')">Deactivate</button>` :
                    `<button class="success-btn" onclick="activateUser(${user.id}, '${user.user_type}')">Activate</button>`
                  }
                  <button class="danger-btn" onclick="deleteUser(${user.id}, '${user.user_type}')">Delete</button>
                </td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          content.innerHTML = html;
        }
      } catch (error) {
        content.innerHTML = '<div class="error-state">Failed to load users</div>';
      }
    }

    // Load appointments
    async function loadAppointments() {
      const content = document.getElementById('appointmentsContent');
      content.innerHTML = '<div class="loading">Loading appointments...</div>';

      try {
        const result = await apiCall('get_all_appointments_admin');
        if (result.success && result.data) {
          let html = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Client</th>
                  <th>Pet</th>
                  <th>Service</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;

          result.data.forEach(appointment => {
            html += `
              <tr>
                <td>${appointment.id}</td>
                <td>${appointment.client_name}</td>
                <td>${appointment.pet_name}</td>
                <td>${appointment.service_name}</td>
                <td>${appointment.appointment_date}</td>
                <td>${appointment.status}</td>
                <td>
                  <button class="danger-btn" onclick="deleteAppointment(${appointment.id})">Delete</button>
                </td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          content.innerHTML = html;
        }
      } catch (error) {
        content.innerHTML = '<div class="error-state">Failed to load appointments</div>';
      }
    }

    // Load pets
    async function loadPets() {
      const content = document.getElementById('petsContent');
      content.innerHTML = '<div class="loading">Loading pets...</div>';

      try {
        const result = await apiCall('get_all_pets_admin');
        if (result.success && result.data) {
          let html = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Owner</th>
                  <th>Species</th>
                  <th>Breed</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;

          result.data.forEach(pet => {
            html += `
              <tr>
                <td>${pet.id}</td>
                <td>${pet.name}</td>
                <td>${pet.owner_name}</td>
                <td>${pet.species}</td>
                <td>${pet.breed || 'N/A'}</td>
                <td>
                  <button class="danger-btn" onclick="deletePet(${pet.id})">Delete</button>
                </td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          content.innerHTML = html;
        }
      } catch (error) {
        content.innerHTML = '<div class="error-state">Failed to load pets</div>';
      }
    }

    // Load staff
    async function loadStaff() {
      const content = document.getElementById('staffContent');
      content.innerHTML = '<div class="loading">Loading staff...</div>';

      try {
        const result = await apiCall('get_all_staff_admin');
        if (result.success && result.data) {
          let html = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Position</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;

          result.data.forEach(staff => {
            html += `
              <tr>
                <td>${staff.id}</td>
                <td>${staff.name}</td>
                <td>${staff.email}</td>
                <td>${staff.position}</td>
                <td class="status-${staff.status}">${staff.status.toUpperCase()}</td>
                <td>
                  ${staff.status === 'active' ? 
                    `<button class="danger-btn" onclick="deactivateUser(${staff.id}, 'staff')">Deactivate</button>` :
                    `<button class="success-btn" onclick="activateUser(${staff.id}, 'staff')">Activate</button>`
                  }
                  <button class="danger-btn" onclick="deleteUser(${staff.id}, 'staff')">Delete</button>
                </td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          content.innerHTML = html;
        }
      } catch (error) {
        content.innerHTML = '<div class="error-state">Failed to load staff</div>';
      }
    }

    // User management functions
    async function deactivateUser(userId, userType) {
      if (confirm(`Are you sure you want to deactivate this ${userType}?`)) {
        try {
          const result = await apiCall('deactivate_user_admin', { user_id: userId, user_type: userType });
          if (result.success) {
            showToast(result.message, 'success');
            if (currentSection === 'users') loadUsers();
            else if (currentSection === 'staff') loadStaff();
            loadDashboardStats();
          }
        } catch (error) {
          showToast('Failed to deactivate user', 'error');
        }
      }
    }

    async function activateUser(userId, userType) {
      try {
        const result = await apiCall('activate_user_admin', { user_id: userId, user_type: userType });
        if (result.success) {
          showToast(result.message, 'success');
          if (currentSection === 'users') loadUsers();
          else if (currentSection === 'staff') loadStaff();
          loadDashboardStats();
        }
      } catch (error) {
        showToast('Failed to activate user', 'error');
      }
    }

    async function deleteUser(userId, userType) {
      if (confirm(`‚ö†Ô∏è DANGER: Are you sure you want to PERMANENTLY DELETE this ${userType}? This cannot be undone!`)) {
        try {
          const result = await apiCall('delete_user_admin', { user_id: userId, user_type: userType });
          if (result.success) {
            showToast('User deleted permanently', 'success');
            if (currentSection === 'users') loadUsers();
            else if (currentSection === 'staff') loadStaff();
            loadDashboardStats();
          }
        } catch (error) {
          showToast('Failed to delete user', 'error');
        }
      }
    }

    async function deleteAppointment(appointmentId) {
      if (confirm('‚ö†Ô∏è Are you sure you want to delete this appointment?')) {
        try {
          const result = await apiCall('delete_appointment_admin', { appointment_id: appointmentId });
          if (result.success) {
            showToast('Appointment deleted', 'success');
            loadAppointments();
            loadDashboardStats();
          }
        } catch (error) {
          showToast('Failed to delete appointment', 'error');
        }
      }
    }

    async function deletePet(petId) {
      if (confirm('‚ö†Ô∏è Are you sure you want to delete this pet record? This will also delete all related appointments!')) {
        try {
          const result = await apiCall('delete_pet_admin', { pet_id: petId });
          if (result.success) {
            showToast('Pet record deleted', 'success');
            loadPets();
            loadDashboardStats();
          }
        } catch (error) {
          showToast('Failed to delete pet', 'error');
        }
      }
    }

    // Database management functions
    function resetDatabase() {
      if (confirm('‚ö†Ô∏è EXTREME DANGER: This will DELETE ALL DATA and reset the database to default state. Are you absolutely sure?')) {
        if (confirm('This action CANNOT be undone. Type "DELETE ALL" to confirm.')) {
          window.location.href = 'reset_database.php';
        }
      }
    }

    function deleteAllUsers() {
      if (confirm('‚ö†Ô∏è DANGER: Delete ALL user accounts? This cannot be undone!')) {
        // Implement delete all users
        showToast('Feature not implemented yet', 'warning');
      }
    }

    function deleteAllAppointments() {
      if (confirm('‚ö†Ô∏è DANGER: Delete ALL appointments? This cannot be undone!')) {
        // Implement delete all appointments
        showToast('Feature not implemented yet', 'warning');
      }
    }

    function backupDatabase() {
      showToast('Database backup started...', 'info');
      // Implement backup functionality
    }

    function optimizeDatabase() {
      showToast('Database optimization started...', 'info');
      // Implement optimization functionality
    }

    // Utility functions
    function refreshData() {
      loadDashboardStats();
      if (currentSection === 'users') loadUsers();
      else if (currentSection === 'appointments') loadAppointments();
      else if (currentSection === 'pets') loadPets();
      else if (currentSection === 'staff') loadStaff();
      showToast('Data refreshed', 'success');
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = 'homepage.html';
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type} show`;
      toast.innerHTML = `
        <div class="toast-icon">
          ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
        </div>
        <div class="toast-message">${message}</div>
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
