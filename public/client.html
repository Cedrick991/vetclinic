<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Dashboard - Tattao Veterinary Clinic</title>
  <link rel="stylesheet" href="../assets/css/enhanced-style.css">
  <link rel="stylesheet" href="../assets/css/modern-dashboard.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="description" content="Client Dashboard - Tattao Veterinary Clinic Management System">
    </style>
   </head>
<body>
  <!-- Client Dashboard Container -->
  <div class="client-container">
    
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="profile-picture-container">
          <img src="../assets/images/logoo.jpg" alt="Profile" id="clientAvatar">
          <div class="profile-picture-overlay">
            <i class="fas fa-camera"></i>
            <input type="file" id="sidebarProfileInput" accept="image/*" style="display: none;">
          </div>
        </div>
        <h3 id="clientName">John Cedrick Unida</h3>
        <p id="clientEmail">Loading...</p>
      </div>
      
      <div class="sidebar-nav">
        <a href="#dashboard" class="nav-item active" data-section="dashboard">
          <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
        </a>
        <a href="#appointments" class="nav-item" data-section="appointments">
          <i class="fas fa-calendar-alt"></i> <span>My Appointments</span>
        </a>
        <a href="#pets" class="nav-item" data-section="pets">
          <i class="fas fa-paw"></i> <span>My Pets</span>
        </a>
        <a href="#orders" class="nav-item" data-section="orders">
          <i class="fas fa-shopping-bag"></i> <span>My Orders</span>
        </a>
        <a href="#reports" class="nav-item" data-section="reports">
          <i class="fas fa-file-pdf"></i> <span>Pet Reports</span>
        </a>
        <a href="#settings" class="nav-item" data-section="settings">
          <i class="fas fa-cog"></i> <span>Settings</span>
        </a>
        <a href="#" class="nav-item" data-section="logout">
          <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
        </a>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">

      <!-- Header Bar -->
      <header class="header-bar">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleSidebar(); return false;">
          <i class="fas fa-bars"></i>
        </button>

        <div class="header-content" style="display: flex; justify-content: flex-start; align-items: center; width: 100%;">

          <!-- Left Group with Title, Search, Cart, and Back Button -->
          <div class="left-group" style="display: flex; align-items: center; gap: 20px;">
            <!-- Title -->
            <div class="header-title">
              <h1 id="pageTitle" style="color: #ffffff; font-size: 18px; margin: 0; font-weight: 600;"><i class="fas fa-paw" style="color: #ffffff; margin-right: 8px;"></i> Welcome to Your Dashboard</h1>
            </div>

            <!-- Search Container -->
            <div class="search-container">
              <i class="fas fa-search"></i>
              <input type="text" placeholder="Search for pet products, services..." />
            </div>

            <!-- Cart Icon -->
            <div class="cart-icon" id="cartIcon" onclick="viewCart()" style="display: none;">
              <i class="fas fa-shopping-cart"></i>
              <span class="cart-count">0</span>
            </div>

            <!-- Back to Home Button -->
            <button class="home-btn" onclick="window.location.href='../index.html'" style="background: rgba(255, 255, 255, 0.1); color: #ffffff; border: 1px solid rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;">
              <i class="fas fa-home"></i> Back to Home
            </button>
          </div>
        </div>
     </header>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        
        <!-- Welcome Section -->
        <div class="welcome-section">
          <h2 class="welcome-title">
            <i class="fas fa-paw"></i> Welcome to Your Dashboard
          </h2>
          <p class="welcome-subtitle">Manage your pets, appointments, and more from one place</p>
        </div>

        <!-- Dashboard Section -->
        <section id="dashboardSection" class="content-section" style="display: block;">
          <div class="section-header" style="margin-bottom: 20px;">
            <h2 class="section-title" style="color: #ffffff; font-size: 20px; margin: 0; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-tachometer-alt" style="color: #ffffff;"></i> Dashboard Overview
            </h2>
          </div>

          <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="dashboard-card" id="upcomingAppointments" style="background: #122d47; color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div class="card-title" style="color: #ffffff; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                <i class="fas fa-calendar-alt" style="color: #ffffff; font-size: 16px;"></i> Upcoming Appointments
              </div>
              <div class="card-value" style="color: #ffffff; font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="upcomingAppointmentsCount">0</div>
              <div class="card-subtitle" style="color: rgba(255, 255, 255, 0.8); font-size: 12px; font-weight: 400;">Scheduled appointments</div>
            </div>

            <div class="dashboard-card" id="clientPets" style="background: #122d47; color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div class="card-title" style="color: #ffffff; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                <i class="fas fa-paw" style="color: #ffffff; font-size: 16px;"></i> My Pets
              </div>
              <div class="card-value" style="color: #ffffff; font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="clientPetsCount">0</div>
              <div class="card-subtitle" style="color: rgba(255, 255, 255, 0.8); font-size: 12px; font-weight: 400;">Registered pets</div>
            </div>

            <div class="dashboard-card" id="cartItems" style="background: #122d47; color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div class="card-title" style="color: #ffffff; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                <i class="fas fa-shopping-cart" style="color: #ffffff; font-size: 16px;"></i> Cart Items
              </div>
              <div class="card-value" style="color: #ffffff; font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="cartItemsCount">0</div>
              <div class="card-subtitle" style="color: rgba(255, 255, 255, 0.8); font-size: 12px; font-weight: 400;">Items in cart</div>
            </div>

            <div class="dashboard-card" id="completedVisits" style="background: #122d47; color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div class="card-title" style="color: #ffffff; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                <i class="fas fa-check-circle" style="color: #ffffff; font-size: 16px;"></i> Completed Visits
              </div>
              <div class="card-value" style="color: #ffffff; font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="completedVisitsCount">0</div>
              <div class="card-subtitle" style="color: rgba(255, 255, 255, 0.8); font-size: 12px; font-weight: 400;">Total completed</div>
            </div>
          </div>
        </section>
        
        <!-- Appointments Section -->
        <section id="appointmentsSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-calendar-alt"></i> My Appointments
            </h2>
            <button class="header-btn" data-action="book-appointment">
              <i class="fas fa-plus"></i> Book New
            </button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Pet</th>
                  <th>Service</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="appointmentsTableBody">
                <tr>
                  <td colspan="6" class="loading">
                    <div class="spinner"></div>
                    Loading appointments...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section id="petsSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-paw"></i> My Pets
            </h2>
            <button class="header-btn" data-action="add-pet">
              <i class="fas fa-plus"></i> Add Pet
            </button>
          </div>
          <div id="petsGrid" class="pets-grid">
            <div class="loading">
              <div class="spinner"></div>
              Loading pets...
            </div>
          </div>
        </section>


        <section id="ordersSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-shopping-bag"></i> My Orders
            </h2>
          </div>
          <div id="ordersContent" class="loading">
            <div class="spinner"></div>
            Loading orders...
          </div>
        </section>

        <section id="reportsSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-file-pdf"></i> Pet Reports
            </h2>
          </div>

          <!-- Pet Selection -->
          <div class="reports-container">
            <div class="reports-card">
              <div class="card-header">
                <h3><i class="fas fa-paw"></i> Select Pet for Report</h3>
              </div>
              <div class="reports-form">
                <div class="form-group">
                  <label for="petSelect">Choose a Pet:</label>
                  <select id="petSelect" class="form-control">
                    <option value="">Select a pet...</option>
                  </select>
                </div>
                <div class="form-actions">
                  <button id="generateReportBtn" class="btn-primary" onclick="generatePetReport()" disabled>
                    <i class="fas fa-file-pdf"></i> Generate Report
                  </button>
                </div>
              </div>
            </div>

            <!-- Report Preview -->
            <div id="reportPreview" class="reports-card hidden">
              <div class="card-header">
                <h3><i class="fas fa-eye"></i> Report Preview</h3>
              </div>
              <div id="reportContent" class="report-preview">
                <div class="loading">
                  <div class="spinner"></div>
                  Loading report preview...
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="settingsSection" class="content-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title" style="color: #ffffff; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-cog" style="color: #ffffff;"></i> Settings
            </h2>
          </div>

          <div class="settings-container" style="display: grid; gap: 20px; max-width: 800px;">

            <!-- Profile Information Settings -->
            <div class="settings-card" style="background: #08355f; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <div class="card-header" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h3 style="color: #ffffff; margin: 0; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-user" style="color: #5DADE2;"></i> Profile Information
                </h3>
              </div>
              <form id="profileForm" class="settings-form">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                  <div class="form-group">
                    <label for="firstName" style="color: #ffffff; font-size: 14px; margin-bottom: 6px; display: block;">First Name *</label>
                    <input type="text" id="firstName" name="first_name" required style="width: 100%; padding: 10px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 14px;">
                  </div>
                  <div class="form-group">
                    <label for="lastName" style="color: #ffffff; font-size: 14px; margin-bottom: 6px; display: block;">Last Name *</label>
                    <input type="text" id="lastName" name="last_name" required style="width: 100%; padding: 10px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 14px;">
                  </div>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                  <label for="email" style="color: #ffffff; font-size: 14px; margin-bottom: 6px; display: block;">Email Address *</label>
                  <input type="email" id="email" name="email" required style="width: 100%; padding: 10px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                  <label for="phone" style="color: #ffffff; font-size: 14px; margin-bottom: 6px; display: block;">Phone Number</label>
                  <input type="tel" id="phone" name="phone" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 14px;">
                </div>
                <div class="form-actions" style="text-align: right;">
                  <button type="submit" class="btn-primary" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
                    <i class="fas fa-save"></i> Update Profile
                  </button>
                </div>
              </form>
            </div>

            <!-- Password Settings -->
            <div class="settings-card" style="background: #08355f; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <div class="card-header" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h3 style="color: #ffffff; margin: 0; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-lock" style="color: #5DADE2;"></i> Change Password
                </h3>
              </div>
              <form id="passwordForm" class="settings-form">
                <div class="form-group" style="margin-bottom: 16px;">
                  <label for="currentPassword" style="color: #ffffff; font-size: 14px; margin-bottom: 6px; display: block;">Current Password *</label>
                  <input type="password" id="currentPassword" name="current_password" required style="width: 100%; padding: 10px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 14px;">
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                  <div class="form-group">
                    <label for="newPassword" style="color: #ffffff; font-size: 14px; margin-bottom: 6px; display: block;">New Password *</label>
                    <input type="password" id="newPassword" name="new_password" required minlength="6" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 14px;">
                  </div>
                  <div class="form-group">
                    <label for="confirmPassword" style="color: #ffffff; font-size: 14px; margin-bottom: 6px; display: block;">Confirm New Password *</label>
                    <input type="password" id="confirmPassword" name="confirm_password" required minlength="6" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 14px;">
                  </div>
                </div>
                <div class="form-actions" style="text-align: right;">
                  <button type="submit" class="btn-primary" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
                    <i class="fas fa-key"></i> Update Password
                  </button>
                </div>
              </form>
            </div>

            <!-- Profile Picture Settings -->
            <div class="settings-card" style="background: #08355f; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <div class="card-header" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h3 style="color: #ffffff; margin: 0; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-camera" style="color: #5DADE2;"></i> Profile Picture
                </h3>
              </div>
              <div class="profile-picture-section" style="display: grid; grid-template-columns: auto 1fr; gap: 20px; align-items: center;">
                <div class="current-picture">
                  <img id="currentProfilePicture" src="../assets/images/logoo.jpg" alt="Profile Picture" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255, 255, 255, 0.2);">
                  <p style="color: rgba(255, 255, 255, 0.7); font-size: 12px; margin: 8px 0 0 0; text-align: center;">Current Picture</p>
                </div>
                <div class="upload-section">
                  <form id="pictureForm" class="settings-form">
                    <div class="form-group" style="margin-bottom: 16px;">
                      <label for="profilePictureInput" style="color: #ffffff; font-size: 14px; margin-bottom: 6px; display: block;">Choose New Picture</label>
                      <input type="file" id="profilePictureInput" accept="image/*" required style="width: 100%; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 14px;">
                    </div>
                    <div class="image-preview" style="margin-bottom: 16px;">
                      <img id="imagePreview" src="" alt="Preview" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255, 255, 255, 0.3); display: none;">
                    </div>
                    <div class="form-actions" style="display: flex; gap: 12px;">
                      <button type="button" class="btn-secondary" onclick="document.getElementById('profilePictureInput').click()" style="background: rgba(255, 255, 255, 0.1); color: #ffffff; border: 1px solid rgba(255, 255, 255, 0.2); padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.2s ease;">
                        <i class="fas fa-folder-open"></i> Choose File
                      </button>
                      <button type="submit" class="btn-primary" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
                        <i class="fas fa-upload"></i> Upload Picture
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>


  <!-- Dashboard JavaScript -->
  <script src="../assets/js/dashboard.js"></script>
  <script src="../assets/js/client-dashboard.js"></script>
<script>
  // Mobile sidebar toggle functionality
  function toggleSidebar() {
    console.log('Toggle sidebar clicked!'); // Debug log

    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    const toggleBtn = document.getElementById('mobileMenuToggle');

    console.log('Elements found:', { sidebar, overlay, toggleBtn }); // Debug log

    if (sidebar && overlay) {
      const isOpen = sidebar.classList.contains('mobile-open');
      console.log('Sidebar is open:', isOpen); // Debug log

      if (isOpen) {
        // Close sidebar
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('active');
        if (toggleBtn) {
          toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
          toggleBtn.setAttribute('aria-expanded', 'false');
        }
        console.log('Sidebar closed'); // Debug log
      } else {
        // Open sidebar
        sidebar.classList.add('mobile-open');
        overlay.classList.add('active');
        if (toggleBtn) {
          toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
          toggleBtn.setAttribute('aria-expanded', 'true');
        }
        console.log('Sidebar opened'); // Debug log
      }
    } else {
      console.error('Sidebar or overlay elements not found!'); // Debug log
    }
  }

  // Alternative event listener for better mobile support
  document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('mobileMenuToggle');
    if (toggleBtn) {
      // Add touch event support for mobile devices
      toggleBtn.addEventListener('touchstart', function(e) {
        e.preventDefault();
        toggleSidebar();
      }, { passive: false });

      // Add keyboard support
      toggleBtn.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleSidebar();
        }
      });

      // Set initial ARIA attributes
      toggleBtn.setAttribute('aria-expanded', 'false');
      toggleBtn.setAttribute('aria-controls', 'sidebar');
      toggleBtn.setAttribute('aria-label', 'Toggle navigation menu');
    }
  });

  // Close sidebar when clicking outside on mobile
  document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    const toggleBtn = document.getElementById('mobileMenuToggle');

    if (window.innerWidth <= 768) {
      if (sidebar && overlay && toggleBtn) {
        if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
          sidebar.classList.remove('mobile-open');
          overlay.classList.remove('active');
          toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
        }
      }
    }
  });

  // Handle logout functionality
  async function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
      try {
        // Call logout API endpoint
        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'logout' })
        });

        const result = await response.json();

        if (result.success) {
          window.location.href = '../public/homepage.html';
        } else {
          alert('Logout failed. Redirecting anyway...');
          window.location.href = '../public/homepage.html';
        }
      } catch (error) {
        console.error('Logout error:', error);
        alert('Logout failed. Redirecting anyway...');
        window.location.href = '../public/homepage.html';
      }
    }
  }

    function showSection(sectionName) {
      // Hide all sections
      const sections = document.querySelectorAll('.content-section');
      sections.forEach(section => {
        section.style.display = 'none';
        section.classList.add('hidden');
      });

      // Remove active class from all nav items
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.classList.remove('active');
      });

      // Show selected section
      const targetSection = document.getElementById(sectionName + 'Section');
      if (targetSection) {
        targetSection.style.display = 'block';
        targetSection.classList.remove('hidden');

        // Load section-specific data
        if (sectionName === 'store' && window.dashboardInstance) {
          window.dashboardInstance.loadStoreSection();
        } else if (sectionName === 'appointments' && window.dashboardInstance) {
          window.dashboardInstance.loadAppointmentsSection();
        } else if (sectionName === 'pets' && window.dashboardInstance) {
          window.dashboardInstance.loadPetsSection();
        } else if (sectionName === 'reports') {
          initializeReportsSection();
        } else if (sectionName === 'settings') {
          loadClientSettingsData();
        } else if (sectionName === 'orders') {
          loadOrders();
        }
      }

      // Add active class to clicked nav item
      const activeNavItem = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
      if (activeNavItem) {
        activeNavItem.classList.add('active');
      }

      // Update page title
      const titles = {
        'dashboard': '<i class="fas fa-paw"></i> Welcome to Your Dashboard',
        'appointments': '<i class="fas fa-calendar-alt"></i> My Appointments',
        'pets': '<i class="fas fa-paw"></i> My Pets',
        'store': '<i class="fas fa-store"></i> Store',
        'orders': '<i class="fas fa-shopping-bag"></i> My Orders',
        'settings': '<i class="fas fa-cog"></i> Settings'
      };

      const pageTitle = document.getElementById('pageTitle');
      if (pageTitle && titles[sectionName]) {
        pageTitle.innerHTML = titles[sectionName];
      }

      // Load products when store section is shown
      if (sectionName === 'store') {
        loadClientProducts();
      }

      // Load pets when pets section is shown
      if (sectionName === 'pets') {
        loadClientPets();
      }
    }

    // Load products for client store
    async function loadClientProducts() {
      const productsGrid = document.getElementById('clientProductsGrid');
      if (!productsGrid) return;

      try {
        productsGrid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading products...</div>';

        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'get_products' })
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        // Debug: Log the API response
        console.log('API Response:', result);

        if (result.success && result.data && Array.isArray(result.data)) {
          console.log('Products received:', result.data.length, 'products');
          if (result.data.length === 0) {
            productsGrid.innerHTML = '<div class="loading"><p>No products available at the moment. Please check back later!</p></div>';
          } else {
            displayClientProducts(result.data);
          }
        } else {
          const errorMessage = result.message || 'Failed to load products';
          console.error('API Error:', errorMessage);
          console.error('Full API response:', result);
          productsGrid.innerHTML = `<div class="loading"><p>Unable to load products: ${errorMessage}</p></div>`;
        }
      } catch (error) {
        console.error('Error loading products:', error);
        productsGrid.innerHTML = '<div class="loading"><p>Error loading products. Please try again later.</p></div>';
      }
    }

    function displayClientProducts(products) {
      const productsGrid = document.getElementById('clientProductsGrid');
      if (!productsGrid) return;

      if (products.length === 0) {
        productsGrid.innerHTML = '<div class="loading"><p>No products available at the moment.</p></div>';
        return;
      }

      productsGrid.innerHTML = products.map(product => createClientProductCard(product)).join('');
    }

    function createClientProductCard(product) {
      // Handle image loading with better error handling
      let imageHtml = '';
      let placeholderHtml = '<div class="product-image-placeholder"><i class="fas fa-image"></i></div>';

      if (product.image && product.image.trim() !== '' && product.image !== null && product.image !== 'null') {
        // Debug: Log the image path to console
        console.log('Product image path:', product.image, 'for product:', product.name);

        // Try multiple possible image paths
        const imagePaths = [
          product.image, // Original path
          product.image.replace(/\.(jpg|jpeg|png)$/i, '.jpg'), // Try as .jpg
          product.image.replace(/\.(jpg|jpeg|png)$/i, '.png'), // Try as .png
        ];

        // Remove duplicates and empty paths
        const uniquePaths = [...new Set(imagePaths)].filter(path => path && path.trim() !== '');

        if (uniquePaths.length > 0) {
          // Try multiple path variations to ensure we find the correct one
          const possiblePaths = [];

          uniquePaths.forEach(path => {
            // Try with full prefix
            if (path.startsWith('assets/images/products/')) {
              possiblePaths.push('../' + path);
            } else {
              possiblePaths.push('../assets/images/products/' + path);
            }

            // Also try without the ../ prefix
            if (path.startsWith('assets/images/products/')) {
              possiblePaths.push(path);
            } else {
              possiblePaths.push('assets/images/products/' + path);
            }
          });

          // Remove duplicates
          const finalPaths = [...new Set(possiblePaths)];
          const correctPath = finalPaths[0];

          console.log('üìÅ Client Dashboard: Final image path for', product.name, ':', correctPath);
          console.log('üîç Client Dashboard: All possible paths:', finalPaths);

          imageHtml = `<img src="${correctPath}" alt="${product.name}"
            onerror="tryNextImage(this, '${product.image}', '${finalPaths.join('|')}')"
            loading="lazy">`;
        }
      } else {
        console.log('No image path for product:', product.name);
      }

      const stockClass = product.stock === 0 ? 'stock-out' : product.stock < 10 ? 'stock-low' : 'stock-good';
      const stockText = product.stock === 0 ? 'Out of Stock' : product.stock < 10 ? 'Low Stock' : 'In Stock';

      // Add to Order button - disabled if out of stock
      const addToCartButton = product.stock === 0
        ? `<button class="action-btn add-to-cart" disabled title="Out of Stock">
            <i class="fas fa-shopping-cart"></i> Out of Stock
          </button>`
        : `<button class="action-btn add-to-cart" onclick="addToCart(${product.id}, '${product.name}', ${product.price})" title="Add to Order">
            <i class="fas fa-shopping-cart"></i> Add to Order
          </button>`;

      const inStockClass = product.stock > 0 ? 'in-stock' : '';

      return `
        <div class="product-card ${inStockClass}">
          <div class="product-image">
            ${imageHtml}
            ${imageHtml ? '' : placeholderHtml}
          </div>
          <div class="product-info">
            <div class="product-name">${product.name}</div>
            <div class="product-category">${product.category}</div>
            <div class="product-description">${product.description || 'No description available'}</div>
            <div class="product-details">
              <div class="product-price">‚Ç±${parseFloat(product.price).toFixed(2)}</div>
              <div class="product-stock">
                <span class="stock-badge ${stockClass}">${stockText} (${product.stock})</span>
              </div>
            </div>
            <div class="product-actions">
              ${addToCartButton}
              <button class="action-btn buy-now" onclick="buyNow(${product.id}, '${product.name}', ${product.price})" title="Buy Now">
                <i class="fas fa-shopping-cart"></i> Buy Now
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Cart functionality
    let cart = JSON.parse(localStorage.getItem('clientCart') || '[]');

    // Function to try next image path when current one fails
    function tryNextImage(img, originalImage, pipeSeparatedPaths) {
      const imagePaths = pipeSeparatedPaths.split('|').filter(path => path && path.trim() !== '');

      // Debug: Log the attempt
      console.log('Trying next image for:', originalImage, 'Remaining paths:', imagePaths);

      // If no more paths to try, show placeholder
      if (imagePaths.length === 0) {
        console.log('No more paths to try, showing placeholder for:', originalImage);
        img.style.display = 'none';
        const placeholder = img.nextElementSibling;
        if (placeholder && placeholder.classList.contains('product-image-placeholder')) {
          placeholder.style.display = 'flex';
        }
        return;
      }

      // Try multiple path variations for the first path
      const currentPath = imagePaths[0];
      const possiblePaths = [];

      // Try with full prefix
      if (currentPath.startsWith('assets/images/products/')) {
        possiblePaths.push('../' + currentPath);
      } else {
        possiblePaths.push('../assets/images/products/' + currentPath);
      }

      // Also try without the ../ prefix
      if (currentPath.startsWith('assets/images/products/')) {
        possiblePaths.push(currentPath);
      } else {
        possiblePaths.push('assets/images/products/' + currentPath);
      }

      const nextPath = possiblePaths[0];
      console.log('Trying path:', nextPath, 'for image:', originalImage);
      console.log('All possible paths for this attempt:', possiblePaths);

      img.src = nextPath;
      img.onerror = function() {
        // Remove the failed path and try again with remaining paths
        const remainingPaths = imagePaths.slice(1);
        if (remainingPaths.length > 0) {
          tryNextImage(img, originalImage, remainingPaths.join('|'));
        } else {
          // No more paths, show placeholder
          console.log('All paths failed for:', originalImage, 'showing placeholder');
          img.style.display = 'none';
          const placeholder = img.nextElementSibling;
          if (placeholder && placeholder.classList.contains('product-image-placeholder')) {
            placeholder.style.display = 'flex';
          }
        }
      };
    }

    function addToCart(productId, productName, price) {
      // Check if product is already in cart
      const existingItem = cart.find(item => item.id === productId);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({
          id: productId,
          name: productName,
          price: price,
          quantity: 1
        });
      }

      // Save to localStorage
      localStorage.setItem('clientCart', JSON.stringify(cart));

      // Update cart count
      updateCartCount();

      // Show success message
      showToast(`${productName} added to order!`, 'success');
    }

    function buyNow(productId, productName, price) {
      // Add item to cart with quantity 1
      const existingItem = cart.find(item => item.id === productId);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({
          id: productId,
          name: productName,
          price: price,
          quantity: 1
        });
      }

      // Save to localStorage
      localStorage.setItem('clientCart', JSON.stringify(cart));

      // Update cart count
      updateCartCount();

      // Show success message and proceed to checkout
      showToast(`${productName} added to order! Proceeding to checkout...`, 'success');

      // Proceed to checkout after a short delay
      setTimeout(() => {
        checkout();
      }, 1000);
    }

    function updateCartCount() {
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartCountElements = document.querySelectorAll('#cartCount, .cart-count');

      cartCountElements.forEach(element => {
        element.textContent = totalItems;
      });

      // Update header cart icon
      const cartIcon = document.getElementById('cartIcon');
      if (cartIcon) {
        cartIcon.style.display = totalItems > 0 ? 'block' : 'none';
      }
    }

    function viewCart() {
      if (cart.length === 0) {
        showToast('Your cart is empty', 'info');
        return;
      }

      // Create cart modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h3><i class="fas fa-shopping-cart"></i> Your Cart</h3>
            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <div class="modal-body">
            <div class="cart-items">
              ${cart.map(item => `
                <div class="cart-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e1e5e9;">
                  <div>
                    <h4 style="margin: 0; font-size: 16px;">${item.name}</h4>
                    <p style="margin: 4px 0; color: #666;">‚Ç±${item.price.toFixed(2)} each</p>
                  </div>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <button onclick="updateCartItemQuantity(${item.id}, ${item.quantity - 1})" style="width: 24px; height: 24px; border: none; background: #f8f9fa; border-radius: 4px; cursor: pointer;">-</button>
                      <span style="min-width: 20px; text-align: center; font-weight: 500; color: #333; font-size: 16px;">${item.quantity}</span>
                      <button onclick="updateCartItemQuantity(${item.id}, ${item.quantity + 1})" style="width: 24px; height: 24px; border: none; background: #f8f9fa; border-radius: 4px; cursor: pointer;">+</button>
                    </div>
                    <button onclick="removeFromCart(${item.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="cart-total" style="margin-top: 20px; padding-top: 16px; border-top: 2px solid #e1e5e9; text-align: right;">
              <h3 style="margin: 0; font-size: 18px;">
                Total: ‚Ç±${cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}
              </h3>
            </div>
            <div class="cart-actions" style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="this.closest('.modal').remove()" class="btn-secondary">Continue Shopping</button>
              <button onclick="checkout()" class="btn-primary">
                <i class="fas fa-shopping-bag"></i> Buy Now
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.style.display = 'block';
    }

    function updateCartItemQuantity(productId, newQuantity) {
      if (newQuantity <= 0) {
        removeFromCart(productId);
        return;
      }

      const item = cart.find(item => item.id === productId);
      if (item) {
        item.quantity = newQuantity;
        localStorage.setItem('clientCart', JSON.stringify(cart));
        updateCartCount();
        viewCart(); // Refresh the cart modal
      }
    }

    function removeFromCart(productId) {
      cart = cart.filter(item => item.id !== productId);
      localStorage.setItem('clientCart', JSON.stringify(cart));
      updateCartCount();
      viewCart(); // Refresh the cart modal
    }

    function checkout() {
      if (cart.length === 0) {
        showToast('Your cart is empty', 'error');
        return;
      }

      // Calculate total for the order
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      // Create order data for payment processing
      const orderData = {
        items: cart,
        total: total
      };

      // Show payment modal using the dashboard instance
      if (window.dashboardInstance) {
        window.dashboardInstance.showPaymentModalForCart(orderData);
        // Close the cart modal
        const cartModal = document.querySelector('.modal');
        if (cartModal) {
          cartModal.remove();
        }
      } else {
        // Fallback if dashboard instance is not available
        showToast('Payment system is loading. Please try again in a moment.', 'info');
        // Close the cart modal anyway
        const cartModal = document.querySelector('.modal');
        if (cartModal) {
          cartModal.remove();
        }
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type} show`;
      toast.innerHTML = `
        <div class="toast-icon">
          ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
        </div>
        <div class="toast-message">${message}</div>
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize cart count and load orders on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateCartCount();

      // Load dashboard data if we're on the dashboard section
      if (document.getElementById('dashboardSection') && document.getElementById('dashboardSection').style.display === 'block') {
        loadClientDashboardData();
      }

      // Load orders if we're on the orders section
      if (document.getElementById('ordersSection') && !document.getElementById('ordersSection').classList.contains('hidden')) {
        loadOrders();
      }

      // Add event delegation for order action buttons
      setupOrderEventDelegation();
    });

    // Load client dashboard data
    async function loadClientDashboardData() {
      try {
        console.log('Loading client dashboard data...');

        // Load pets data
        const petsResponse = await fetch('../api/pet_reports_api.php?action=get_pet_list');
        const petsResult = await petsResponse.json();

        if (petsResult.success && petsResult.data) {
          const petsCount = petsResult.data.length;
          const petsCountElement = document.getElementById('clientPetsCount');
          if (petsCountElement) {
            petsCountElement.textContent = petsCount;
          }
          console.log('Pets count loaded:', petsCount);
        }

        // Load appointments data
        const appointmentsResponse = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'get_appointments' })
        });
        const appointmentsResult = await appointmentsResponse.json();

        if (appointmentsResult.success && appointmentsResult.data) {
          const appointments = appointmentsResult.data;
          const today = new Date().toISOString().split('T')[0];

          // Count upcoming appointments (future dates)
          const upcomingCount = appointments.filter(apt =>
            apt.appointment_date >= today && apt.status !== 'cancelled'
          ).length;

          // Count completed appointments
          const completedCount = appointments.filter(apt =>
            apt.status === 'completed'
          ).length;

          // Update upcoming appointments count
          const upcomingElement = document.getElementById('upcomingAppointmentsCount');
          if (upcomingElement) {
            upcomingElement.textContent = upcomingCount;
          }

          // Update completed visits count
          const completedElement = document.getElementById('completedVisitsCount');
          if (completedElement) {
            completedElement.textContent = completedCount;
          }

          console.log('Appointments loaded - Upcoming:', upcomingCount, 'Completed:', completedCount);
        }

        // Cart items count is already handled by updateCartCount()

      } catch (error) {
        console.error('Error loading client dashboard data:', error);
      }
    }

    // Setup event delegation for order action buttons
    function setupOrderEventDelegation() {
      document.addEventListener('click', function(event) {
        // Handle cancel order buttons
        if (event.target.matches('.cancel-order-btn') || event.target.closest('.cancel-order-btn')) {
          event.preventDefault();
          const button = event.target.matches('.cancel-order-btn') ? event.target : event.target.closest('.cancel-order-btn');
          const orderCard = button.closest('.order-card');
          if (orderCard) {
            const orderId = parseInt(orderCard.querySelector('.order-info h3').textContent.replace('Order #', ''));
            if (orderId) {
              cancelOrderEnhanced(orderId);
            }
          }
        }

        // Handle buy again buttons
        if (event.target.matches('.buy-now-order') || event.target.closest('.buy-now-order')) {
          event.preventDefault();
          const button = event.target.matches('.buy-now-order') ? event.target : event.target.closest('.buy-now-order');
          const orderCard = button.closest('.order-card');
          if (orderCard) {
            const orderId = parseInt(orderCard.querySelector('.order-info h3').textContent.replace('Order #', ''));
            if (orderId) {
              buyAgain(orderId);
            }
          }
        }

        // Handle view details buttons
        if (event.target.matches('.btn-secondary') && event.target.textContent.includes('View Details')) {
          event.preventDefault();
          const button = event.target;
          const orderCard = button.closest('.order-card');
          if (orderCard) {
            const orderId = parseInt(orderCard.querySelector('.order-info h3').textContent.replace('Order #', ''));
            if (orderId) {
              viewOrderDetails(orderId);
            }
          }
        }
      });
    }

    // Profile Form Submission Functionality for Client Dashboard
    function setupProfileForm() {
      const profileForm = document.getElementById('profileForm');

      if (profileForm) {
        profileForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          // Get form data
          const formData = new FormData(profileForm);

          // Validate form data
          if (!validateProfileForm(formData)) {
            return;
          }

          try {
            const response = await fetch('../api/vet_api.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'update_profile',
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                email: formData.get('email'),
                phone: formData.get('phone')
              })
            });

            const result = await response.json();

            if (result.success) {
              showToast('Profile updated successfully!', 'success');

              // Update sidebar with new data
              if (result.user) {
                const clientName = document.getElementById('clientName');
                if (clientName) {
                  clientName.textContent = result.user.name;
                }
              }

              // Refresh user data
              await loadClientSettingsData();
            } else {
              showToast(result.message || 'Failed to update profile', 'error');
            }
          } catch (error) {
            console.error('Profile update error:', error);
            showToast('Failed to update profile. Please try again.', 'error');
          }
        });
      }
    }

    // Load client settings data
    async function loadClientSettingsData() {
      try {
        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'get_user_info' })
        });

        const result = await response.json();

        if (result.success && result.data && result.data.user) {
          const user = result.data.user;

          // Populate settings forms with current data
          const firstNameInput = document.getElementById('firstName');
          const lastNameInput = document.getElementById('lastName');
          const emailInput = document.getElementById('email');
          const phoneInput = document.getElementById('phone');

          if (firstNameInput) firstNameInput.value = user.first_name || '';
          if (lastNameInput) lastNameInput.value = user.last_name || '';
          if (emailInput) emailInput.value = user.email || '';
          if (phoneInput) phoneInput.value = user.phone || '';

          // Update profile picture in settings section
          if (user.profile_picture) {
            const currentProfilePicture = document.getElementById('currentProfilePicture');
            if (currentProfilePicture) {
              const newSrc = '../' + user.profile_picture + '?t=' + Date.now();
              currentProfilePicture.src = newSrc;

              // Add error handling
              currentProfilePicture.onerror = function() {
                this.src = '../assets/images/logoo.jpg';
              };
            }
          }
        }
      } catch (error) {
        console.error('Failed to load client settings data:', error);
      }
    }

    // Profile form validation
    function validateProfileForm(formData) {
      const firstName = formData.get('first_name');
      const lastName = formData.get('last_name');
      const email = formData.get('email');
      const phone = formData.get('phone');

      // Validate first name
      if (!firstName || firstName.trim().length < 2) {
        showToast('First name must be at least 2 characters', 'error');
        return false;
      }

      // Validate last name
      if (!lastName || lastName.trim().length < 2) {
        showToast('Last name must be at least 2 characters', 'error');
        return false;
      }

      // Validate email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        showToast('Please enter a valid email address', 'error');
        return false;
      }

      // Validate phone (optional)
      if (phone && phone.trim() !== '') {
        const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
        if (!phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''))) {
          showToast('Please enter a valid phone number', 'error');
          return false;
        }
      }

      return true;
    }

    // Profile Picture Upload Functionality for Client Dashboard
    function setupProfilePictureForm() {
      const pictureForm = document.getElementById('pictureForm');
      const fileInput = document.getElementById('profilePictureInput');
      const imagePreview = document.getElementById('imagePreview');
      const currentPicture = document.getElementById('currentProfilePicture');

      if (fileInput && imagePreview) {
        // Handle file selection
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
              showToast('Please select a valid image file', 'error');
              return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
              showToast('Image size must be less than 5MB', 'error');
              return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
              imagePreview.src = e.target.result;
              imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        });
      }

      if (pictureForm) {
        pictureForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const fileInput = document.getElementById('profilePictureInput');
          if (!fileInput.files[0]) {
            showToast('Please select an image file', 'error');
            return;
          }

          const file = fileInput.files[0];

          // Validate file type
          if (!file.type.startsWith('image/')) {
            showToast('Please select a valid image file', 'error');
            return;
          }

          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            showToast('Image size must be less than 5MB', 'error');
            return;
          }

          try {
            // Convert file to base64
            const reader = new FileReader();
            reader.onload = async function(e) {
              const base64Data = e.target.result;

              const response = await fetch('../api/vet_api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  action: 'upload_profile_picture',
                  image_data: base64Data,
                  image_name: file.name
                })
              });

              const result = await response.json();

              if (result.success) {
                showToast('Profile picture updated successfully!', 'success');

                // Update current picture display in settings
                if (currentPicture && result.image_path) {
                  const fullImagePath = '../' + result.image_path;
                  console.log('Updating settings profile picture to:', fullImagePath);
                  currentPicture.src = fullImagePath + '?t=' + Date.now();

                  // Also update the settings section currentProfilePicture
                  const settingsProfilePicture = document.getElementById('currentProfilePicture');
                  if (settingsProfilePicture) {
                    settingsProfilePicture.src = fullImagePath + '?t=' + Date.now();
                    settingsProfilePicture.onerror = function() {
                      this.src = '../assets/images/logoo.jpg';
                    };
                  }
                }

                // Update sidebar avatar with delay to ensure file is fully written
                const clientAvatar = document.getElementById('clientAvatar');
                if (clientAvatar && result.image_path) {
                  setTimeout(() => {
                    const timestamp = Date.now() + Math.random(); // More unique cache buster
                    const fullImagePath = '../' + result.image_path;
                    console.log('Updating sidebar avatar to:', fullImagePath);
                    clientAvatar.src = fullImagePath + '?t=' + timestamp;

                    // Handle sidebar avatar load error with retry and format fallback
                    let retryCount = 0;
                    const basePath = '../' + result.image_path.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');

                    clientAvatar.onerror = function() {
                      retryCount++;
                      if (retryCount < 3) {
                        console.warn(`Retry ${retryCount} for sidebar avatar:`, fullImagePath);
                        // Try again with a new timestamp
                        const retrySrc = '../' + result.image_path + '?t=' + Date.now() + Math.random();
                        this.src = retrySrc;
                      } else if (retryCount === 3) {
                        console.warn('Trying alternative format (PNG) for sidebar avatar:', basePath + '.png');
                        // Try PNG format
                        this.src = basePath + '.png?t=' + Date.now() + Math.random();
                        retryCount++; // Increment to 4
                      } else if (retryCount === 4) {
                        console.warn('Trying alternative format (WebP) for sidebar avatar:', basePath + '.webp');
                        // Try WebP format
                        this.src = basePath + '.webp?t=' + Date.now() + Math.random();
                        retryCount++; // Increment to 5
                      } else {
                        console.warn('Failed to load sidebar avatar after all retries and formats, using fallback:', fullImagePath);
                        this.src = '../assets/images/logoo.jpg';
                      }
                    };

                    // Add load handler with validation
                    clientAvatar.onload = function() {
                      // Verify the image actually loaded by checking its dimensions
                      if (this.naturalWidth === 0 || this.naturalHeight === 0) {
                        console.warn('Sidebar avatar loaded but has invalid dimensions, retrying:', fullImagePath);
                        // Trigger error handler to retry
                        this.onerror();
                      } else {
                        console.log('Sidebar avatar loaded successfully:', fullImagePath, this.naturalWidth + 'x' + this.naturalHeight);
                      }
                    };
                  }, 500); // 500ms delay to ensure file is fully written
                }

                // Reset form
                imagePreview.style.display = 'none';
                fileInput.value = '';
              } else {
                showToast(result.message || 'Failed to upload profile picture', 'error');
              }
            };

            reader.onerror = function() {
              showToast('Error reading file', 'error');
            };

            reader.readAsDataURL(file);
          } catch (error) {
            console.error('Error uploading profile picture:', error);
            showToast('Error uploading profile picture', 'error');
          }
        });
      }
    }

    // Initialize profile and picture functionality
    document.addEventListener('DOMContentLoaded', function() {
      setupProfileForm();
      setupProfilePictureForm();
      // Load settings data when settings section is shown
      if (document.getElementById('settingsSection') && !document.getElementById('settingsSection').classList.contains('hidden')) {
        loadClientSettingsData();
      }
    });

    // Orders functionality
    async function loadOrders() {
      const ordersContent = document.getElementById('ordersContent');
      if (!ordersContent) return;

      try {
        ordersContent.innerHTML = '<div class="loading"><div class="spinner"></div>Loading orders...</div>';

        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'get_orders' })
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          console.log('Orders loaded successfully:', result.data);
          let orders = result.data;
          if (!Array.isArray(orders)) {
            orders = orders ? [orders] : [];
          }
          if (orders.length > 0) {
            // Store orders globally for buyAgain function
            window.currentOrders = orders;
            displayOrders(orders);
          } else {
            console.log('No orders found');
            window.currentOrders = [];
            ordersContent.innerHTML = `
              <div class="empty-state full-width">
                <i class="fas fa-shopping-bag"></i>
                <h3>No Orders Yet</h3>
                <p>You haven't placed any orders yet. Browse our store to get started!</p>
                <button class="btn-primary" onclick="showSection('store')">
                  <i class="fas fa-store"></i> Browse Store
                </button>
              </div>
            `;
          }
        } else {
          console.log('No orders found or API error:', result);
          window.currentOrders = [];
          ordersContent.innerHTML = `
            <div class="empty-state full-width">
              <i class="fas fa-shopping-bag"></i>
              <h3>No Orders Yet</h3>
              <p>You haven't placed any orders yet. Browse our store to get started!</p>
              <button class="btn-primary" onclick="showSection('store')">
                <i class="fas fa-store"></i> Browse Store
              </button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        window.currentOrders = [];
        ordersContent.innerHTML = `
          <div class="error-state full-width">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load orders. Please try again later.</p>
            <button class="btn-secondary" onclick="loadOrders()">Retry</button>
          </div>
        `;
      }
    }

    function displayOrders(orders) {
      const ordersContent = document.getElementById('ordersContent');
      if (!ordersContent) return;

      // Create orders HTML
      let ordersHtml = '';
      if (orders && orders.length > 0) {
        ordersHtml = `
          <div class="orders-grid">
            ${orders.map(order => createOrderCard(order)).join('')}
          </div>
        `;
      } else {
        ordersHtml = `
          <div class="empty-state full-width">
            <i class="fas fa-shopping-bag"></i>
            <h3>No Orders Yet</h3>
            <p>You haven't placed any orders yet. Browse our store to get started!</p>
            <button class="btn-primary" onclick="showSection('store')">
              <i class="fas fa-store"></i> Browse Store
            </button>
          </div>
        `;
      }

      // Always include the static button
      ordersContent.innerHTML = `
        ${ordersHtml}
        <!-- Quick Actions Section - Blue Theme -->
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 24px; margin: 24px 0; border-radius: 12px; border: 1px solid #e1e5e9; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <h3 style="color: #667eea; margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">
            <i class="fas fa-shopping-cart"></i> Quick Actions
          </h3>
          <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
            <button onclick="handleQuickBuyNow()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <i class="fas fa-credit-card"></i> Buy Now
            </button>
            <button onclick="handleQuickCancelOrder()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <i class="fas fa-times"></i> Cancel Order
            </button>
            <button onclick="handleQuickViewDetails()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <i class="fas fa-eye"></i> View Details
            </button>
          </div>
        </div>
      `;
    }

    function createOrderCard(order) {
      const orderDate = new Date(order.order_date).toLocaleDateString();
      const orderTime = new Date(order.order_date).toLocaleTimeString();

      // Format payment method display
      const paymentMethodDisplay = {
        'gcash': 'GCash',
        'bank': 'Bank Transfer',
        'cash_on_visit': 'Cash on Visit'
      };

      const paymentMethod = paymentMethodDisplay[order.payment_method] || order.payment_method;

      // Add cancel button for pending orders only
      const status = (order.status || '').toLowerCase();
      const canCancel = status === 'pending';
      const cancelButton = canCancel ? `
        <button class="cancel-order-btn" onclick="cancelOrder(${order.id})" title="Cancel this order">
          <i class="fas fa-times"></i> Cancel Order
        </button>
      ` : '';

      // Add Buy Again button for completed orders
      const canBuyAgain = status === 'completed';
      const buyAgainButton = canBuyAgain ? `
        <button class="buy-now-order" onclick="buyAgain(${order.id})" title="Buy these items again">
          <i class="fas fa-shopping-cart"></i> Buy Again
        </button>
      ` : '';

      // Add Pay Now button for pending and confirmed orders
      const canPay = status === 'pending' || status === 'confirmed';
      const payNowButton = canPay ? `
        <button class="buy-now-order" onclick="alert('Pay Now for order ${order.id}')" title="Complete payment for this order">
          <i class="fas fa-credit-card"></i> Pay Now
        </button>
      ` : '';

      // Add Reorder button for cancelled orders
      const canReorder = status === 'cancelled';
      const reorderButton = canReorder ? `
        <button class="buy-now-order" onclick="buyAgain(${order.id})" title="Reorder this item">
          <i class="fas fa-shopping-cart"></i> Reorder
        </button>
      ` : '';

      return `
        <div class="order-card" style="position: relative; z-index: 1;">
          <div class="order-header">
            <div class="order-info">
              <h3>Order #${order.id}</h3>
              <p class="order-date">${orderDate} at ${orderTime}</p>
              <p class="payment-method">
                <i class="fas fa-credit-card"></i>
                ${paymentMethod}
              </p>
            </div>
            <div class="order-status status-${order.status.toLowerCase()}">
              ${order.status}
            </div>
          </div>
          <div class="order-items">
            ${(order.items || []).map(item => `
              <div class="order-item">
                <div class="item-info">
                  <h4>${item.name}</h4>
                  <p style="color: #333; font-weight: 500;">Quantity: ${item.quantity} √ó ‚Ç±${parseFloat(item.price).toFixed(2)}</p>
                </div>
                <div class="item-price">
                  ‚Ç±${(item.price * item.quantity).toFixed(2)}
                </div>
              </div>
            `).join('')}
          </div>
          <div class="order-actions" style="display: flex !important; visibility: visible !important;">
            <div class="left-actions">
              ${cancelButton}
            </div>
            <div class="right-actions">
              <button class="btn-secondary" onclick="viewOrderDetails(${order.id})">
                <i class="fas fa-eye"></i> View Details
              </button>
            </div>
          </div>
          <div class="order-total" style="display: flex !important; visibility: visible !important;">
            <div class="total-with-button">
              <span class="total-amount">Total: ‚Ç±${parseFloat(order.total_amount).toFixed(2)}</span>
            </div>
            ${buyAgainButton}
            ${payNowButton}
            ${reorderButton}
          </div>
        </div>
      `;
    }

    function buyAgain(orderId) {
      // Find the order by ID
      const order = window.currentOrders?.find(o => o.id === orderId);
      if (!order) {
        showToast('Order not found', 'error');
        return;
      }

      // Convert order items to cart format
      const cartItems = order.items.map(item => ({
        id: item.product_id,
        name: item.name,
        price: parseFloat(item.price),
        quantity: item.quantity
      }));

      // Calculate total
      const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      // Create order data for payment processing
      const orderData = {
        items: cartItems,
        total: total
      };

      // Show payment modal using the dashboard instance
      if (window.dashboardInstance) {
        window.dashboardInstance.showPaymentModalForCart(orderData);
      } else {
        // Fallback if dashboard instance is not available
        showToast('Payment system is loading. Please try again in a moment.', 'info');
      }
    }

    function viewOrderDetails(orderId) {
      // Create order details modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h3><i class="fas fa-shopping-bag"></i> Order Details</h3>
            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <div class="modal-body">
            <p>Order details functionality will be implemented here.</p>
            <p>Order ID: ${orderId}</p>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.style.display = 'block';
    }

    async function cancelOrder(orderId) {
      if (!confirm('Are you sure you want to cancel this order? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'cancel_order',
            order_id: orderId
          })
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          showToast('Order cancelled successfully!', 'success');
          // Reload orders to reflect the changes
          loadOrders();
        } else {
          showToast(result.message || 'Failed to cancel order', 'error');
        }
      } catch (error) {
        console.error('Error cancelling order:', error);
        showToast('Error cancelling order. Please try again later.', 'error');
      }
    }

    // Enhanced cancel order function with better error handling
    async function cancelOrderEnhanced(orderId) {
      // Find the order to get more details
      const order = window.currentOrders?.find(o => o.id === orderId);
      if (!order) {
        showToast('Order not found', 'error');
        return;
      }

      // Check if order can be cancelled
      if (order.status.toLowerCase() !== 'pending') {
        showToast('Only pending orders can be cancelled', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to cancel Order #${orderId}? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'cancel_order',
            order_id: orderId
          })
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          showToast('Order cancelled successfully!', 'success');
          // Reload orders to reflect the changes
          loadOrders();
        } else {
          showToast(result.message || 'Failed to cancel order', 'error');
        }
      } catch (error) {
        console.error('Error cancelling order:', error);
        showToast('Error cancelling order. Please try again later.', 'error');
      }
    }

    // Handler functions for quick actions
    function handleQuickBuyNow() {
      if (window.dashboardInstance) {
        // Show store section to allow user to add items to cart
        showSection('store');
        showToast('Browse our store and add items to your cart!', 'info');
      } else {
        showToast('Store is loading. Please try again in a moment.', 'info');
      }
    }

    function handleQuickCancelOrder() {
      showToast('Please select an order to cancel from the orders list above.', 'info');
    }

    function handleQuickViewDetails() {
      showToast('Please select an order to view details from the orders list above.', 'info');
    }

    // Test function to force load orders
    function testOrderLoading() {
      console.log('Testing order loading...');

      // Clear the orders content
      const ordersContent = document.getElementById('ordersContent');
      if (!ordersContent) {
        console.error('Orders content element not found!');
        return;
      }

      // Create a test order manually
      const testOrder = {
        id: 999,
        order_date: new Date().toISOString(),
        payment_method: 'test',
        status: 'pending',
        total_amount: 999.99,
        items: [{
          name: 'Test Product',
          quantity: 1,
          price: 999.99,
          product_id: 1
        }]
      };

      console.log('Creating test order:', testOrder);

      // Use displayOrders function to ensure button is included
      displayOrders([testOrder]);

      console.log('Test order created successfully!');
    }

    // Client Reports functionality
    let currentReportData = null;

    // Load pets for report selection
    async function loadPetsForReports() {
      const petSelect = document.getElementById('petSelect');
      if (!petSelect) return;

      try {
        const response = await fetch('../api/pet_reports_api.php?action=get_pet_list', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data && Array.isArray(result.data)) {
          // Clear existing options except the first one
          petSelect.innerHTML = '<option value="">Select a pet...</option>';

          if (result.data.length === 0) {
            petSelect.innerHTML += '<option value="" disabled>No pets available</option>';
            document.getElementById('generateReportBtn').disabled = true;
          } else {
            // Add pet options
            result.data.forEach(pet => {
              const option = document.createElement('option');
              option.value = pet.id;
              option.textContent = `${pet.name} (${pet.species} - ${pet.breed || 'Mixed'})`;
              petSelect.appendChild(option);
            });
            document.getElementById('generateReportBtn').disabled = false;
          }
        } else {
          const errorMessage = result.message || 'Failed to load pets';
          console.error('API Error:', errorMessage);
          petSelect.innerHTML += '<option value="" disabled>Error loading pets</option>';
          document.getElementById('generateReportBtn').disabled = true;
        }
      } catch (error) {
        console.error('Error loading pets:', error);
        petSelect.innerHTML += '<option value="" disabled>Error loading pets</option>';
        document.getElementById('generateReportBtn').disabled = true;
      }
    }

    // Generate pet report
    async function generatePetReport() {
      const petSelect = document.getElementById('petSelect');
      const reportPreview = document.getElementById('reportPreview');
      const reportContent = document.getElementById('reportContent');
      const generateBtn = document.getElementById('generateReportBtn');

      const petId = petSelect.value;
      if (!petId) {
        showToast('Please select a pet first', 'error');
        return;
      }

      try {
        // Disable button and show loading
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        reportPreview.classList.remove('hidden');
        reportContent.innerHTML = '<div class="loading"><div class="spinner"></div>Loading report...</div>';

        const response = await fetch(`../api/pet_reports_api.php?action=get_pet_report&pet_id=${petId}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          currentReportData = result.data;
          displayReportPreview(result.data);
        } else {
          const errorMessage = result.message || 'Failed to generate report';
          console.error('API Error:', errorMessage);
          reportContent.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to generate report: ${errorMessage}</p></div>`;
        }
      } catch (error) {
        console.error('Error generating report:', error);
        reportContent.innerHTML = '<div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>Error generating report. Please try again later.</p></div>';
      } finally {
        // Re-enable button
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Generate Report';
      }
    }

    // Display report preview
    function displayReportPreview(data) {
      const reportContent = document.getElementById('reportContent');
      if (!reportContent) return;

      const pet = data.pet;
      const owner = data.owner;
      const statistics = data.statistics;

      const reportHtml = `
        <h1><i class="fas fa-file-medical"></i> Pet Medical Report</h1>

        <div class="statistics">
          <div class="stat-item">
            <div class="stat-value">${statistics.total_appointments}</div>
            <div class="stat-label">Total Appointments</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${statistics.total_vaccinations}</div>
            <div class="stat-label">Vaccinations</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${statistics.last_visit ? new Date(statistics.last_visit).toLocaleDateString() : 'None'}</div>
            <div class="stat-label">Last Visit</div>
          </div>
        </div>

        <h2><i class="fas fa-paw"></i> Pet Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Name</div>
            <div class="info-value">${pet.name}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Species</div>
            <div class="info-value">${pet.species}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Breed</div>
            <div class="info-value">${pet.breed || 'Not specified'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Age</div>
            <div class="info-value">${pet.age}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Gender</div>
            <div class="info-value">${pet.gender}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Weight</div>
            <div class="info-value">${pet.weight}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Color</div>
            <div class="info-value">${pet.color || 'Not specified'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Registration Date</div>
            <div class="info-value">${new Date(pet.registration_date).toLocaleDateString()}</div>
          </div>
        </div>

        ${pet.notes ? `
        <div class="info-item" style="grid-column: 1 / -1;">
          <div class="info-label">Notes</div>
          <div class="info-value">${pet.notes}</div>
        </div>
        ` : ''}

        <h2><i class="fas fa-user"></i> Owner Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Name</div>
            <div class="info-value">${owner.name}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Email</div>
            <div class="info-value">${owner.email}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Phone</div>
            <div class="info-value">${owner.phone || 'Not provided'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Address</div>
            <div class="info-value">${owner.address || 'Not provided'}</div>
          </div>
        </div>

        <h2><i class="fas fa-stethoscope"></i> Medical History</h2>
        ${data.medical_history && data.medical_history.length > 0 ? `
        <div class="section">
          <div style="margin-bottom: 20px; text-align: center;">
            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              <i class="fas fa-file-medical"></i> Total Records: ${data.medical_history.length}
            </span>
          </div>

          <div class="medical-details">
            ${data.medical_history.map((record, index) => `
              <div class="medical-record" style="margin: 25px 0; padding: 25px; border: 2px solid #667eea; border-radius: 15px; background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15); position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 15px; border-radius: 0 15px 0 15px; font-size: 12px; font-weight: 600;">
                  #${index + 1}
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e1e5e9;">
                  <h4 style="margin: 0 0 10px 0; color: #667eea; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-file-medical"></i> Medical Record
                  </h4>
                  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px; color: #666;">
                      <div><i class="fas fa-calendar"></i> <strong>Date:</strong> ${new Date(record.created_at).toLocaleDateString()}</div>
                      <div><i class="fas fa-user-md"></i> <strong>Staff:</strong> ${record.staff_name || 'Not recorded'}</div>
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                  <div style="background: #ffffff; padding: 15px; border-radius: 10px; border-left: 5px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                      <i class="fas fa-stethoscope"></i> Diagnosis
                    </div>
                    <div style="color: #555; line-height: 1.6; padding-left: 25px;">${record.diagnosis ? record.diagnosis.replace(/\n/g, '<br>') : 'Not specified'}</div>
                  </div>

                  <div style="background: #ffffff; padding: 15px; border-radius: 10px; border-left: 5px solid #28a745; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                      <i class="fas fa-thermometer-three-quarters"></i> Treatment
                    </div>
                    <div style="color: #555; line-height: 1.6; padding-left: 25px;">${record.treatment ? record.treatment.replace(/\n/g, '<br>') : 'Not specified'}</div>
                  </div>

                  <div style="background: #ffffff; padding: 15px; border-radius: 10px; border-left: 5px solid #ffc107; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                      <i class="fas fa-pills"></i> Medications
                    </div>
                    <div style="color: #555; line-height: 1.6; padding-left: 25px;">${record.medications ? record.medications.replace(/\n/g, '<br>') : 'None prescribed'}</div>
                  </div>

                  ${record.follow_up_date ? `
                  <div style="background: #ffffff; padding: 15px; border-radius: 10px; border-left: 5px solid #dc3545; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                      <i class="fas fa-calendar-check"></i> Follow-up Date
                    </div>
                    <div style="color: #555; line-height: 1.6; padding-left: 25px;">${new Date(record.follow_up_date).toLocaleDateString()}</div>
                  </div>
                  ` : ''}

                  ${record.notes ? `
                  <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border-left: 5px solid #ffc107; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 8px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                      <i class="fas fa-sticky-note"></i> Clinical Notes
                    </div>
                    <div style="color: #856404; line-height: 1.6; padding-left: 25px;">${record.notes.replace(/\n/g, '<br>')}</div>
                  </div>
                  ` : ''}

                  ${record.instructions ? `
                  <div style="background: #d1ecf1; padding: 15px; border-radius: 10px; border-left: 5px solid #17a2b8; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #0c5460; margin-bottom: 8px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                      <i class="fas fa-clipboard-list"></i> Instructions
                    </div>
                    <div style="color: #0c5460; line-height: 1.6; padding-left: 25px;">${record.instructions.replace(/\n/g, '<br>')}</div>
                  </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        ` : '<div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; margin: 20px 0;"><i class="fas fa-file-medical" style="font-size: 48px; color: #667eea; margin-bottom: 15px;"></i><p style="color: #666; font-style: italic; font-size: 16px;">No medical history available for this pet</p></div>'}

        <h2><i class="fas fa-calendar-alt"></i> Appointment History</h2>
        ${data.appointments && data.appointments.length > 0 ? `
        <table class="appointment-table">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Service</th>
              <th>Staff</th>
              <th>Status</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            ${data.appointments.map(appointment => `
              <tr>
                <td>${new Date(appointment.appointment_date).toLocaleDateString()}<br><small>${new Date(appointment.appointment_time).toLocaleTimeString()}</small></td>
                <td>${appointment.service_name}</td>
                <td>${appointment.staff_first_name && appointment.staff_last_name ? `${appointment.staff_first_name} ${appointment.staff_last_name}` : 'Not assigned'}</td>
                <td>${appointment.status}</td>
                <td>${appointment.notes || 'No notes'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <p><strong>Total Appointments:</strong> ${data.appointments.length}</p>
        ` : '<p>No appointment history available</p>'}

        <div style="margin-top: 40px; padding: 20px; background: #e9ecef; border-radius: 8px; text-align: center;">
          <button onclick="downloadPetReport()" class="action-btn view" title="Print Report">
            <i class="fas fa-print"></i> Print Report
          </button>
          <p style="margin-top: 10px; font-size: 12px; color: #666;">
            Generated on ${new Date().toLocaleString()}
          </p>
        </div>
      `;

      reportContent.innerHTML = reportHtml;
    }

    // Download pet report as PDF
    async function downloadPetReport() {
      if (!currentReportData) {
        showToast('No report data available', 'error');
        return;
      }

      try {
        showToast('Generating PDF...', 'info');

        // Load jsPDF library if not already loaded
        if (typeof window.jspdf === 'undefined') {
          await loadJSPDFLibrary();
        }

        // Wait a bit for library to initialize
        await new Promise(resolve => setTimeout(resolve, 500));

        // Check if jsPDF is available
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
          throw new Error('PDF library not available');
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();

        const pet = currentReportData.pet;
        const owner = currentReportData.owner;

        // Add title
        pdf.setFontSize(20);
        pdf.text('Pet Medical Report', 105, 20, { align: 'center' });

        // Clinic info
        pdf.setFontSize(12);
        pdf.text('Tattoo Veterinary Clinic', 105, 35, { align: 'center' });
        pdf.text('Your Clinic Address | Phone: 0917-519-4639', 105, 42, { align: 'center' });
        pdf.text(`Generated: ${new Date().toLocaleString()}`, 105, 49, { align: 'center' });

        let yPosition = 65;

        // Pet Information
        pdf.setFontSize(16);
        pdf.text('Pet Information', 20, yPosition);
        yPosition += 10;

        pdf.setFontSize(11);
        const petInfo = [
          ['Name:', pet.name],
          ['Species:', pet.species],
          ['Breed:', pet.breed || 'Not specified'],
          ['Age:', pet.age],
          ['Gender:', pet.gender],
          ['Weight:', pet.weight],
          ['Color:', pet.color || 'Not specified'],
          ['Registration Date:', new Date(pet.registration_date).toLocaleDateString()]
        ];

        petInfo.forEach(([label, value]) => {
          pdf.text(`${label} ${value}`, 20, yPosition);
          yPosition += 7;
        });

        if (pet.notes) {
          yPosition += 5;
          pdf.text(`Notes: ${pet.notes}`, 20, yPosition);
          yPosition += 7;
        }

        // Owner Information
        yPosition += 10;
        pdf.setFontSize(16);
        pdf.text('Owner Information', 20, yPosition);
        yPosition += 10;

        pdf.setFontSize(11);
        const ownerInfo = [
          ['Name:', owner.name],
          ['Email:', owner.email],
          ['Phone:', owner.phone || 'Not provided'],
          ['Address:', owner.address || 'Not provided']
        ];

        ownerInfo.forEach(([label, value]) => {
          pdf.text(`${label} ${value}`, 20, yPosition);
          yPosition += 7;
        });

        // Medical History
        if (currentReportData.medical_history && currentReportData.medical_history.length > 0) {
          // Check if we need a new page for medical history
          if (yPosition > 200) {
            pdf.addPage();
            yPosition = 20;
          }

          pdf.setFontSize(16);
          pdf.setTextColor(102, 126, 234);
          pdf.text('Medical History', 20, yPosition);
          pdf.setTextColor(0, 0, 0);
          yPosition += 15;

          pdf.setFontSize(10);
          let recordCount = 0;
          const maxRecordsPerPage = 3; // Limit to 3 records per page to prevent overflow

          for (const record of currentReportData.medical_history) {
            recordCount++;

            // Check if we need a new page
            if (yPosition > 220 || recordCount > maxRecordsPerPage) {
              pdf.addPage();
              yPosition = 20;
              recordCount = 1;
            }

            // Record header with better spacing
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            pdf.text(`${recordCount}. ${new Date(record.created_at).toLocaleDateString()}`, 20, yPosition);
            yPosition += 10;

            // Staff info
            pdf.setFontSize(8);
            pdf.setTextColor(100, 100, 100);
            pdf.text(`   Staff: ${record.staff_name || 'Not recorded'}`, 20, yPosition);
            pdf.setTextColor(0, 0, 0);
            yPosition += 8;

            // Diagnosis with proper text wrapping
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            const diagnosisText = record.diagnosis || 'No diagnosis recorded';
            const diagnosisLines = pdf.splitTextToSize(`   Diagnosis: ${diagnosisText}`, 165);
            pdf.text(diagnosisLines, 20, yPosition);
            yPosition += (diagnosisLines.length * 5) + 5;

            // Treatment with proper text wrapping
            if (record.treatment) {
              const treatmentText = record.treatment;
              const treatmentLines = pdf.splitTextToSize(`   Treatment: ${treatmentText}`, 165);
              pdf.text(treatmentLines, 20, yPosition);
              yPosition += (treatmentLines.length * 5) + 5;
            }

            // Medications with proper text wrapping
            if (record.medications) {
              const medicationText = record.medications;
              const medicationLines = pdf.splitTextToSize(`   Medications: ${medicationText}`, 165);
              pdf.text(medicationLines, 20, yPosition);
              yPosition += (medicationLines.length * 5) + 5;
            }

            // Notes with proper text wrapping
            if (record.notes) {
              const notesText = record.notes;
              const notesLines = pdf.splitTextToSize(`   Notes: ${notesText}`, 165);
              pdf.text(notesLines, 20, yPosition);
              yPosition += (notesLines.length * 5) + 5;
            }

            // Instructions with proper text wrapping
            if (record.instructions) {
              const instructionsText = record.instructions;
              const instructionsLines = pdf.splitTextToSize(`   Instructions: ${instructionsText}`, 165);
              pdf.text(instructionsLines, 20, yPosition);
              yPosition += (instructionsLines.length * 5) + 5;
            }

            // Follow-up date
            if (record.follow_up_date) {
              pdf.text(`   Follow-up: ${new Date(record.follow_up_date).toLocaleDateString()}`, 20, yPosition);
              yPosition += 8;
            }

            // Add space between records
            yPosition += 10;

            // Safety check - if we're getting close to the bottom, start a new page
            if (yPosition > 240) {
              pdf.addPage();
              yPosition = 20;
            }
          }

          // Add note if there are more records than we displayed
          if (currentReportData.medical_history.length > (maxRecordsPerPage * Math.ceil(currentReportData.medical_history.length / maxRecordsPerPage))) {
            yPosition += 5;
            pdf.setFontSize(9);
            pdf.setTextColor(100, 100, 100);
            const remainingRecords = currentReportData.medical_history.length - (maxRecordsPerPage * Math.ceil(currentReportData.medical_history.length / maxRecordsPerPage));
            pdf.text(`... and ${remainingRecords} more medical records (continued on next page)`, 20, yPosition);
            pdf.setTextColor(0, 0, 0);
            yPosition += 10;
          }
        }

        // Appointment History
        if (currentReportData.appointments && currentReportData.appointments.length > 0) {
          yPosition += 10;
          pdf.setFontSize(16);
          pdf.text('Appointment History', 20, yPosition);
          yPosition += 10;

          pdf.setFontSize(10);
          currentReportData.appointments.slice(0, 10).forEach((appointment, index) => {
            if (yPosition > 270) { // New page if needed
              pdf.addPage();
              yPosition = 20;
            }

            pdf.text(`${index + 1}. ${new Date(appointment.appointment_date).toLocaleDateString()} - ${appointment.service_name}`, 20, yPosition);
            yPosition += 7;
          });
        }

        // Save the PDF
        const fileName = `${pet.name.replace(/\s+/g, '_')}_Medical_Report_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);

        showToast('PDF report downloaded successfully!', 'success');
      } catch (error) {
        console.error('Error generating PDF:', error);
        showToast('Error generating PDF. Falling back to HTML...', 'error');

        // Fallback to HTML download
        downloadReportAsHTML();
      }
    }

    // Download report as HTML (fallback)
    function downloadReportAsHTML() {
      if (!currentReportData) {
        showToast('No report data available', 'error');
        return;
      }

      const pet = currentReportData.pet;
      const fileName = `${pet.name.replace(/\s+/g, '_')}_Medical_Report_${new Date().toISOString().split('T')[0]}.html`;

      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Pet Medical Report - ${pet.name}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
            .section { margin-bottom: 30px; }
            .section h3 { background: #f0f0f0; padding: 10px; margin: 0 0 15px 0; border-left: 4px solid #007bff; }
            .info-grid { display: table; width: 100%; }
            .info-row { display: table-row; }
            .info-cell { display: table-cell; padding: 8px; border-bottom: 1px solid #ddd; }
            .info-label { font-weight: bold; width: 30%; }
            .appointment-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            .appointment-table th, .appointment-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .appointment-table th { background-color: #f8f9fa; font-weight: bold; }
            .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Tattoo Veterinary Clinic</h1>
            <h2>Pet Medical Report - ${pet.name}</h2>
          </div>

          <div class="section">
            <h3>Pet Information</h3>
            <div class="info-grid">
              <div class="info-row"><div class="info-cell info-label">Name:</div><div class="info-cell">${pet.name}</div></div>
              <div class="info-row"><div class="info-cell info-label">Species:</div><div class="info-cell">${pet.species}</div></div>
              <div class="info-row"><div class="info-cell info-label">Breed:</div><div class="info-cell">${pet.breed || 'Not specified'}</div></div>
              <div class="info-row"><div class="info-cell info-label">Age:</div><div class="info-cell">${pet.age}</div></div>
              <div class="info-row"><div class="info-cell info-label">Gender:</div><div class="info-cell">${pet.gender}</div></div>
              <div class="info-row"><div class="info-cell info-label">Weight:</div><div class="info-cell">${pet.weight}</div></div>
              <div class="info-row"><div class="info-cell info-label">Color:</div><div class="info-cell">${pet.color || 'Not specified'}</div></div>
              ${pet.notes ? `<div class="info-row"><div class="info-cell info-label">Notes:</div><div class="info-cell">${pet.notes}</div></div>` : ''}
            </div>
          </div>

          <div class="section">
            <h3>Owner Information</h3>
            <div class="info-grid">
              <div class="info-row"><div class="info-cell info-label">Name:</div><div class="info-cell">${currentReportData.owner.name}</div></div>
              <div class="info-row"><div class="info-cell info-label">Email:</div><div class="info-cell">${currentReportData.owner.email}</div></div>
              <div class="info-row"><div class="info-cell info-label">Phone:</div><div class="info-cell">${currentReportData.owner.phone || 'Not provided'}</div></div>
              <div class="info-row"><div class="info-cell info-label">Address:</div><div class="info-cell">${currentReportData.owner.address || 'Not provided'}</div></div>
            </div>
          </div>

          <div class="section">
            <h3>Appointment History</h3>
            <table class="appointment-table">
              <thead>
                <tr><th>Date</th><th>Service</th><th>Staff</th><th>Status</th><th>Notes</th></tr>
              </thead>
              <tbody>
                ${currentReportData.appointments.map(apt => `
                  <tr>
                    <td>${new Date(apt.appointment_date).toLocaleDateString()}</td>
                    <td>${apt.service_name}</td>
                    <td>${apt.staff_first_name && apt.staff_last_name ? `${apt.staff_first_name} ${apt.staff_last_name}` : 'Not assigned'}</td>
                    <td>${apt.status}</td>
                    <td>${apt.notes || 'No notes'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <div class="footer">
            <p>Generated on ${new Date().toLocaleString()}</p>
            <p>This report contains confidential medical information.</p>
          </div>
        </body>
        </html>
      `;

      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('HTML report downloaded successfully!', 'success');
    }

    // Load jsPDF library
    async function loadJSPDFLibrary() {
      return new Promise((resolve, reject) => {
        if (typeof window.jspdf !== 'undefined') {
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => {
          console.log('jsPDF library loaded successfully');
          resolve();
        };
        script.onerror = () => {
          console.error('Failed to load jsPDF library');
          reject(new Error('Failed to load PDF library'));
        };
        document.head.appendChild(script);
      });
    }

    // Initialize reports section when shown
    function initializeReportsSection() {
      loadPetsForReports();
    }

    // Update showSection function to handle reports
    const originalShowSection = showSection;
    showSection = function(sectionName) {
      originalShowSection(sectionName);

      if (sectionName === 'reports') {
        initializeReportsSection();
      }
    };

    // Pet Management Functions for Client Dashboard
    async function loadClientPets() {
      const petsGrid = document.getElementById('petsGrid');
      if (!petsGrid) return;

      try {
        petsGrid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading pets...</div>';

        const response = await fetch('../api/pet_reports_api.php?action=get_pet_list', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data && Array.isArray(result.data)) {
          if (result.data.length === 0) {
            petsGrid.innerHTML = '<div class="loading"><p>You haven\'t registered any pets yet. Add your first pet to get started!</p></div>';
          } else {
            displayClientPets(result.data);
          }
        } else {
          const errorMessage = result.message || 'Failed to load pets';
          console.error('API Error:', errorMessage);
          petsGrid.innerHTML = `<div class="loading"><p>Unable to load pets: ${errorMessage}</p></div>`;
        }
      } catch (error) {
        console.error('Error loading pets:', error);
        petsGrid.innerHTML = '<div class="loading"><p>Error loading pets. Please try again later.</p></div>';
      }
    }

    function displayClientPets(pets) {
      const petsGrid = document.getElementById('petsGrid');
      if (!petsGrid) return;

      if (pets.length === 0) {
        petsGrid.innerHTML = '<div class="loading"><p>No pets found.</p></div>';
        return;
      }

      petsGrid.innerHTML = '';

      pets.forEach(pet => {
        const petCard = createClientPetCard(pet);
        petsGrid.appendChild(petCard);
      });
    }

    function createClientPetCard(pet) {
      const card = document.createElement('div');
      card.className = 'pet-card';

      // Handle image with fallback
      let imageHtml = '';
      let placeholderHtml = `<div class="pet-image-placeholder"><i class="${getSpeciesIcon(pet.species)}"></i></div>`;

      if (pet.image && pet.image.trim() !== '' && pet.image !== null && pet.image !== 'null') {
        imageHtml = `<img src="../${pet.image}" alt="${pet.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
      }

      card.innerHTML = `
        <div class="pet-card-header">
          <h3 class="pet-name">
            <i class="${getSpeciesIcon(pet.species)}"></i>
            ${pet.name}
          </h3>
          <div class="pet-species">${pet.species}</div>
        </div>
        <div class="pet-card-body">
          <div class="pet-info-sections">
            <div class="pet-info-section">
              <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
              <div class="pet-info-item">
                <i class="fas fa-dna"></i>
                <span class="pet-info-label">Breed:</span>
                <span class="pet-info-value">${pet.breed || 'Not specified'}</span>
              </div>
              <div class="pet-info-item">
                <i class="fas fa-venus-mars"></i>
                <span class="pet-info-label">Gender:</span>
                <span class="pet-info-value">${pet.gender || 'Not specified'}</span>
              </div>
            </div>
            <div class="pet-info-section">
              <h4><i class="fas fa-heart"></i> Physical Details</h4>
              <div class="pet-info-item">
                <i class="fas fa-calendar"></i>
                <span class="pet-info-label">Birthdate:</span>
                <span class="pet-info-value">${pet.birthdate ? new Date(pet.birthdate).toLocaleDateString() : 'Not recorded'}</span>
              </div>
              <div class="pet-info-item">
                <i class="fas fa-palette"></i>
                <span class="pet-info-label">Color:</span>
                <span class="pet-info-value">${pet.color || 'Not specified'}</span>
              </div>
            </div>
          </div>
          ${pet.notes ? `
          <div class="pet-notes-section">
            <h4 class="pet-notes-title"><i class="fas fa-sticky-note"></i> Notes</h4>
            <p class="pet-notes">${pet.notes}</p>
          </div>
          ` : ''}
        </div>
        <div class="pet-card-footer">
          <div class="pet-actions">
            <button class="action-btn edit" onclick="editClientPet('${pet.id}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="action-btn delete" onclick="deleteClientPet('${pet.id}', '${pet.name}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      `;

      return card;
    }

    function getSpeciesIcon(species) {
      const icons = {
        'dog': 'fas fa-dog',
        'cat': 'fas fa-cat',
        'bird': 'fas fa-dove',
        'rabbit': 'fas fa-paw',
        'hamster': 'fas fa-paw',
        'fish': 'fas fa-fish',
        'reptile': 'fas fa-paw',
        'other': 'fas fa-paw'
      };
      return icons[species.toLowerCase()] || 'fas fa-paw';
    }

    function viewClientPetDetails(petId) {
      // This will be implemented to show pet details modal
      showToast('View pet details feature coming soon!', 'info');
      console.log('View pet details for ID:', petId);
    }

    function viewClientPetMedicalHistory(petId) {
      // This will be implemented to show pet medical history modal
      showToast('Medical history feature coming soon!', 'info');
      console.log('View medical history for pet ID:', petId);
    }

    function editClientPet(petId) {
      // Create edit pet modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Pet Information</h3>
            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <div class="modal-body">
            <form id="editPetForm">
              <input type="hidden" id="editPetId" name="pet_id" value="${petId}">
              <div class="form-row">
                <div class="form-group">
                  <label for="editPetName">Pet Name *</label>
                  <input type="text" id="editPetName" name="name" required>
                </div>
                <div class="form-group">
                  <label for="editPetSpecies">Species *</label>
                  <select id="editPetSpecies" name="species" required>
                    <option value="">Select Species</option>
                    <option value="dog">Dog</option>
                    <option value="cat">Cat</option>
                    <option value="bird">Bird</option>
                    <option value="rabbit">Rabbit</option>
                    <option value="hamster">Hamster</option>
                    <option value="fish">Fish</option>
                    <option value="reptile">Reptile</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="editPetBreed">Breed</label>
                  <input type="text" id="editPetBreed" name="breed">
                </div>
                <div class="form-group">
                  <label for="editPetBirthdate">Birthdate</label>
                  <input type="date" id="editPetBirthdate" name="birthdate">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="editPetGender">Gender *</label>
                  <select id="editPetGender" name="gender" required>
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="editPetColor">Color</label>
                  <input type="text" id="editPetColor" name="color">
                </div>
              </div>
              <div class="form-group">
                <label for="editPetNotes">Notes</label>
                <textarea id="editPetNotes" name="notes" rows="3" placeholder="Any additional notes about your pet..."></textarea>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                <button type="submit" class="btn-primary">
                  <i class="fas fa-save"></i> Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.style.display = 'block';

      // Load current pet data
      loadPetDataForEdit(petId);

      // Setup form submission
      const editForm = document.getElementById('editPetForm');
      editForm.addEventListener('submit', handleEditPetSubmit);
    }

    async function loadPetDataForEdit(petId) {
      try {
        console.log('Loading pet data for ID:', petId);

        // Try multiple possible API endpoints
        const endpoints = [
          `../api/pet_reports_api.php?action=get_pet_details&pet_id=${petId}`,
          `../api/vet_api.php`,
          `../api/pet_reports_api.php`
        ];

        let response;
        let result = null;

        for (const endpoint of endpoints) {
          try {
            console.log('Trying endpoint:', endpoint);
            if (endpoint.includes('vet_api.php')) {
              // Use POST method for vet_api.php
              response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'get_pet_details', pet_id: petId })
              });
            } else {
              // Use GET method for pet_reports_api.php
              response = await fetch(endpoint + (endpoint.includes('?') ? '&' : '?') + `pet_id=${petId}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
              });
            }

            if (response.ok) {
              const endpointResult = await response.json();
              console.log('Success with endpoint:', endpoint, 'Result:', endpointResult);
              if (endpointResult.success && endpointResult.data) {
                result = endpointResult; // Success, use this result
                break; // Success, exit the loop
              }
            } else {
              console.log('Failed endpoint:', endpoint, 'Status:', response.status);
            }
          } catch (error) {
            console.log('Error with endpoint:', endpoint, 'Error:', error.message);
          }
        }

        console.log('Load pet data response:', result);

        if (result && (result.success && result.data)) {
          const pet = result.data;
          console.log('Pet data received:', pet);

          // Handle different possible data structures
          const petData = pet.pet || pet; // Handle nested structure
          console.log('Using pet data:', petData);

          // Set form values with null checks
          const nameField = document.getElementById('editPetName');
          const speciesField = document.getElementById('editPetSpecies');
          const breedField = document.getElementById('editPetBreed');
          const birthdateField = document.getElementById('editPetBirthdate');
          const genderField = document.getElementById('editPetGender');
          const colorField = document.getElementById('editPetColor');
          const notesField = document.getElementById('editPetNotes');

          if (nameField) {
            nameField.value = petData.name || '';
            console.log('Set name to:', petData.name);
          }
          if (speciesField) {
            speciesField.value = petData.species || '';
            console.log('Set species to:', petData.species);
          }
          if (breedField) {
            breedField.value = petData.breed || '';
            console.log('Set breed to:', petData.breed);
          }
          if (birthdateField) {
            // Handle different date formats
            let birthdateValue = '';
            if (petData.birthdate) {
              if (petData.birthdate instanceof Date) {
                birthdateValue = petData.birthdate.toISOString().split('T')[0];
              } else if (typeof petData.birthdate === 'string' && petData.birthdate !== '0000-00-00') {
                birthdateValue = petData.birthdate.split('T')[0]; // Remove time part if present
              }
            }
            birthdateField.value = birthdateValue;
            console.log('Set birthdate to:', birthdateValue, 'from:', petData.birthdate);
          }
          if (genderField) {
            genderField.value = petData.gender || '';
            console.log('Set gender to:', petData.gender);
          }
          if (colorField) {
            colorField.value = petData.color || '';
            console.log('Set color to:', petData.color);
          }
          if (notesField) {
            notesField.value = petData.notes || '';
            console.log('Set notes to:', petData.notes);
          }

          console.log('Form fields populated successfully');
        } else {
          console.error('Failed to load pet data:', result);
          showToast('Failed to load pet data: ' + (result.message || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error loading pet data:', error);
        showToast('Error loading pet data', 'error');
      }
    }

    async function handleEditPetSubmit(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const petData = {
        action: 'update_pet',
        pet_id: formData.get('pet_id'),
        name: formData.get('name'),
        species: formData.get('species'),
        breed: formData.get('breed'),
        birthdate: formData.get('birthdate'),
        gender: formData.get('gender'),
        color: formData.get('color'),
        notes: formData.get('notes')
      };

      // Debug: Log the data being sent
      console.log('Sending pet update data:', petData);
      console.log('Pet ID being updated:', petData.pet_id);

      try {
        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(petData)
        });

        console.log('Update response status:', response.status);
        console.log('Update response headers:', Object.fromEntries(response.headers.entries()));

        const result = await response.json();
        console.log('Update response:', result);

        if (result.success) {
          showToast('Pet information updated successfully!', 'success');
          e.target.closest('.modal').remove();
          // Reload pets to show updated information
          loadClientPets();
        } else {
          console.error('Update failed:', result);
          showToast(result.message || 'Failed to update pet information', 'error');
        }
      } catch (error) {
        console.error('Error updating pet:', error);
        showToast('Error updating pet information. Check console for details.', 'error');

        // Additional debugging for network errors
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          console.error('Network error - check if API endpoint exists');
          showToast('Network error - cannot connect to server', 'error');
        }

        // Show additional troubleshooting info
        console.log('Troubleshooting tips:');
        console.log('1. Check if ../api/vet_api.php exists');
        console.log('2. Check if the API has update_pet action implemented');
        console.log('3. Check PHP error logs for server-side errors');
        console.log('4. Try the test function: testUpdateAPI(petId, testData)');
      }
    }

    function deleteClientPet(petId, petName) {
      if (confirm(`Are you sure you want to delete ${petName}? This action cannot be undone.`)) {
        // Here you would implement the delete functionality
        showToast(`Delete functionality for ${petName} will be implemented`, 'info');
        console.log('Delete pet ID:', petId, 'Name:', petName);
      }
    }

    // Debug function to test API endpoints
    async function testPetAPI(petId) {
      console.log('=== TESTING PET API ENDPOINTS ===');
      console.log('Testing for pet ID:', petId);

      const endpoints = [
        { name: 'pet_reports_api.php GET', url: `../api/pet_reports_api.php?action=get_pet_details&pet_id=${petId}`, method: 'GET' },
        { name: 'vet_api.php POST', url: '../api/vet_api.php', method: 'POST', data: { action: 'get_pet_details', pet_id: petId } },
        { name: 'pet_reports_api.php POST', url: '../api/pet_reports_api.php', method: 'POST', data: { action: 'get_pet_details', pet_id: petId } }
      ];

      for (const endpoint of endpoints) {
        try {
          console.log(`\n--- Testing ${endpoint.name} ---`);

          let response;
          if (endpoint.method === 'POST') {
            response = await fetch(endpoint.url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(endpoint.data)
            });
          } else {
            response = await fetch(endpoint.url, {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' }
            });
          }

          console.log('Response status:', response.status);
          console.log('Response headers:', Object.fromEntries(response.headers.entries()));

          const result = await response.json();
          console.log('Full response:', result);

          if (result.success && result.data) {
            console.log('‚úÖ SUCCESS! Data structure:', result.data);
            if (result.data.pet) {
              console.log('Found nested pet data:', result.data.pet);
            }
          } else {
            console.log('‚ùå No success or no data');
          }

        } catch (error) {
          console.error('‚ùå Error:', error.message);
        }
      }

      console.log('=== API TEST COMPLETE ===');
    }

    // Add this to window for easy access from browser console
    window.testPetAPI = testPetAPI;

    // Test function for update API
    async function testUpdateAPI(petId, testData) {
      console.log('=== TESTING PET UPDATE API ===');
      console.log('Testing update for pet ID:', petId);
      console.log('Test data:', testData);

      const updateData = {
        action: 'update_pet',
        pet_id: petId,
        name: testData.name || 'Test Name',
        species: testData.species || 'dog',
        breed: testData.breed || 'Test Breed',
        birthdate: testData.birthdate || '2023-01-01',
        gender: testData.gender || 'male',
        color: testData.color || 'Test Color',
        notes: testData.notes || 'Test Notes'
      };

      try {
        console.log('Sending update request to: ../api/vet_api.php');
        console.log('Update data:', updateData);

        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', Object.fromEntries(response.headers.entries()));

        const result = await response.json();
        console.log('Update response:', result);

        if (result.success) {
          console.log('‚úÖ UPDATE SUCCESS!');
        } else {
          console.log('‚ùå UPDATE FAILED:', result.message);
        }

        return result;

      } catch (error) {
        console.error('‚ùå UPDATE ERROR:', error);
        return { success: false, message: error.message };
      }
    }

    // Add to window for console access
    window.testUpdateAPI = testUpdateAPI;
  </script>
</body>
</html>
