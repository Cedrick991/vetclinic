<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Tattao Veterinary Clinic</title>
  <link rel="stylesheet" href="../assets/css/modern-dashboard.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="description" content="Admin Dashboard - Tattao Veterinary Clinic Management System">
  <style>
    /* Admin Dashboard Specific Styles */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #e74c3c 100%);
      background-size: 200% 200%;
      animation: gradientShift 30s ease infinite;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Add the same gradient animation */
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .admin-container {
      display: flex;
      min-height: 100vh;
    }

    /* Admin Sidebar - Different color scheme */
    .sidebar {
      width: 280px;
      background: linear-gradient(145deg, rgba(44,62,80,0.98), rgba(52,73,94,0.95));
      backdrop-filter: blur(15px);
      color: white;
      padding: 0;
      box-shadow: 4px 0 25px rgba(0,0,0,0.5);
      border-right: 3px solid rgba(231,76,60,0.6);
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      transition: all 0.3s ease;
      z-index: 9999;
      display: block !important;
      visibility: visible !important;
      opacity: 1;
    }

    .sidebar-header {
      padding: 25px 20px;
      background: linear-gradient(135deg, rgba(231,76,60,0.9), rgba(192,57,43,0.8));
      text-align: center;
      border-bottom: 3px solid rgba(231,76,60,0.4);
      color: white;
    }

    .sidebar-header img {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      margin-bottom: 10px;
      border: 3px solid rgba(255,255,255,0.3);
      object-fit: contain;
      background: rgba(255,255,255,0.1);
      padding: 5px;
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: white;
    }

    .sidebar-header p {
      margin: 5px 0 0 0;
      font-size: 14px;
      opacity: 0.8;
      color: rgba(255,255,255,0.9);
    }

    .sidebar-nav {
      padding: 20px 0;
    }

    .nav-item {
      display: block;
      padding: 15px 25px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      font-size: 15px;
      font-weight: 500;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(231,76,60,0.3);
      color: #ff6b6b;
      border-left-color: #ff6b6b;
      transform: translateX(5px);
      box-shadow: inset 0 0 20px rgba(231,76,60,0.1);
    }

    .nav-item i {
      margin-right: 12px;
      font-size: 18px;
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
      transition: all 0.3s ease;
      min-width: 0;
      overflow-x: auto;
      position: relative;
      z-index: 1;
    }

    /* Header Bar */
    .header-bar {
      background: linear-gradient(135deg, rgba(44,62,80,0.9), rgba(52,73,94,0.8));
      backdrop-filter: blur(15px);
      border: 2px solid rgba(231,76,60,0.3);
      padding: 20px 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 0 1px rgba(231,76,60,0.2);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      position: relative;
    }

    .header-title h1 {
      margin: 0;
      color: #ff6b6b;
      font-size: 28px;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-shrink: 0;
    }

    .header-btn {
      background: linear-gradient(135deg, #e74c3c, #ff6b6b);
      color: white;
      border: 2px solid rgba(44,62,80,0.3);
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(231,76,60,0.3);
    }

    .header-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(231, 76, 60, 0.5);
    }

    /* Dashboard Cards */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .dashboard-card {
      background: linear-gradient(135deg, rgba(44,62,80,0.9), rgba(52,73,94,0.8));
      backdrop-filter: blur(15px);
      border: 2px solid rgba(231,76,60,0.3);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 0 1px rgba(231,76,60,0.2);
      transition: all 0.3s ease;
      color: white;
    }

    .dashboard-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4), 0 0 20px rgba(231,76,60,0.3);
      border-color: rgba(231,76,60,0.6);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #ff6b6b;
      display: flex;
      align-items: center;
      gap: 10px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
    }

    .card-subtitle {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }

    /* Statistics Cards */
    .stat-card {
      text-align: center;
    }

    /* Content Sections */
    .content-section {
      background: linear-gradient(135deg, rgba(44,62,80,0.9), rgba(52,73,94,0.8));
      backdrop-filter: blur(15px);
      border: 2px solid rgba(231,76,60,0.3);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 0 1px rgba(231,76,60,0.2);
      margin-bottom: 30px;
      color: white;
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(231,76,60,0.3);
    }

    .section-title {
      font-size: 24px;
      font-weight: 600;
      color: #ff6b6b;
      display: flex;
      align-items: center;
      gap: 12px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    /* Table Styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .data-table th,
    .data-table td {
      padding: 15px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .data-table th {
      background: linear-gradient(135deg, rgba(231,76,60,0.9), rgba(192,57,43,0.8));
      font-weight: 600;
      color: white;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(231,76,60,0.4);
    }

    .data-table tr:hover {
      background: rgba(231,76,60,0.1);
      color: #ff6b6b;
    }

    /* Status Badges */
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-active { background: #00b894; color: white; }
    .status-inactive { background: #636e72; color: white; }
    .status-pending { background: #ffeaa7; color: #d63031; }
    .status-confirmed { background: #00b894; color: white; }
    .status-completed { background: #636e72; color: white; }
    .status-cancelled { background: #d63031; color: white; }

    /* Action Buttons */
    .action-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      transition: all 0.3s ease;
      margin-right: 5px;
    }

    .btn-edit { background: #3498db; color: white; }
    .btn-delete { background: #e74c3c; color: white; }
    .btn-view { background: #27ae60; color: white; }
    .btn-activate { background: #f39c12; color: white; }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Loading States */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: rgba(255,255,255,0.7);
    }

    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #ff6b6b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast Notification Styles */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, rgba(44,62,80,0.95), rgba(52,73,94,0.9));
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      border: 2px solid rgba(231,76,60,0.4);
      backdrop-filter: blur(15px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      font-weight: 500;
      font-size: 15px;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 10000;
      max-width: 350px;
      min-width: 200px;
      text-align: center;
      word-wrap: break-word;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: rgba(46, 204, 113, 0.6);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.95), rgba(46, 204, 113, 0.9));
    }

    .toast.error {
      border-color: rgba(231, 76, 60, 0.6);
      background: linear-gradient(135deg, rgba(192, 57, 43, 0.95), rgba(231, 76, 60, 0.9));
    }

    .toast.warning {
      border-color: rgba(241, 196, 15, 0.6);
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.95), rgba(241, 196, 15, 0.9));
      color: #2c3e50;
    }

    .toast.info {
      border-color: rgba(52, 152, 219, 0.6);
      background: linear-gradient(135deg, rgba(41, 128, 185, 0.95), rgba(52, 152, 219, 0.9));
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
        overflow: visible;
      }
      
      .sidebar-header h3,
      .sidebar-header p {
        display: none;
      }
      
      .nav-item span {
        display: none;
      }
      
      .main-content {
        margin-left: 70px;
        padding: 15px 10px;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .header-bar {
        padding: 15px 20px;
        flex-direction: column;
        gap: 15px;
      }
      
      .header-title h1 {
        font-size: 24px;
        text-align: center;
      }
    }

    /* Admin-specific styles */
    .admin-warning {
      background: linear-gradient(135deg, rgba(231,76,60,0.15), rgba(192,57,43,0.1));
      border: 2px solid rgba(231,76,60,0.3);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      color: #e74c3c;
      font-weight: 600;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .quick-action-btn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .quick-action-btn:hover {
      transform: translateY(-2px);
      border-color: #ff6b6b;
      box-shadow: 0 8px 20px rgba(231,76,60,0.3);
    }
  </style>
</head>
<body>
  <!-- Admin Dashboard Container -->
  <div class="admin-container">
    
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="../assets/images/logoo.jpg" alt="Admin Avatar" id="adminAvatar">
        <h3 id="adminName">System Administrator</h3>
        <p id="adminRole">Super Admin</p>
      </div>
      
      <div class="sidebar-nav">
        <a href="#dashboard" class="nav-item active" onclick="showSection('dashboard')">
          <i>üìä</i> <span>Dashboard</span>
        </a>
        <a href="#users" class="nav-item" onclick="showSection('users')">
          <i>üë•</i> <span>User Management</span>
        </a>
        <a href="#appointments" class="nav-item" onclick="showSection('appointments')">
          <i>üìÖ</i> <span>All Appointments</span>
        </a>
        <a href="#pets" class="nav-item" onclick="showSection('pets')">
          <i>üêæ</i> <span>Pet Registry</span>
        </a>
        <a href="#staff" class="nav-item" onclick="showSection('staff')">
          <i>üë®‚Äç‚öïÔ∏è</i> <span>Staff Management</span>
        </a>
        <a href="#services" class="nav-item" onclick="showSection('services')">
          <i>üè•</i> <span>Services</span>
        </a>
        <a href="#settings" class="nav-item" onclick="showSection('settings')">
          <i>‚öôÔ∏è</i> <span>System Settings</span>
        </a>
        <a href="#logs" class="nav-item" onclick="showSection('logs')">
          <i>üìã</i> <span>System Logs</span>
        </a>
        <a href="#" class="nav-item" onclick="handleLogout()">
          <i>üö™</i> <span>Logout</span>
        </a>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
      
      <!-- Header Bar -->
      <header class="header-bar">
        <div class="header-title">
          <h1 id="pageTitle">üõ°Ô∏è Admin Dashboard</h1>
        </div>
        <div class="header-actions">
          <button class="header-btn" onclick="refreshCurrentSection()">
            <i>üîÑ</i> Refresh
          </button>
          <button class="header-btn" onclick="showSystemStatus()">
            <i>üíª</i> System Status
          </button>
        </div>
      </header>

      <!-- Admin Warning -->
      <div class="admin-warning">
        <strong>‚ö†Ô∏è Administrator Access:</strong> You have full system access. Use these tools responsibly.
      </div>

      <!-- Dashboard Overview Section -->
      <section id="dashboardSection" class="content-section active">
        <div class="dashboard-grid">
          <!-- System Statistics Cards -->
          <div class="dashboard-card stat-card">
            <div class="card-header">
              <div class="card-title">üë• Total Users</div>
            </div>
            <div class="card-value" id="totalUsers">0</div>
            <div class="card-subtitle">Clients + Staff members</div>
          </div>
          
          <div class="dashboard-card stat-card">
            <div class="card-header">
              <div class="card-title">üìÖ Total Appointments</div>
            </div>
            <div class="card-value" id="totalAppointments">0</div>
            <div class="card-subtitle">All-time appointments</div>
          </div>
          
          <div class="dashboard-card stat-card">
            <div class="card-header">
              <div class="card-title">üêæ Total Pets</div>
            </div>
            <div class="card-value" id="totalPets">0</div>
            <div class="card-subtitle">Registered pets</div>
          </div>
          
          <div class="dashboard-card stat-card">
            <div class="card-header">
              <div class="card-title">üë®‚Äç‚öïÔ∏è Staff Members</div>
            </div>
            <div class="card-value" id="totalStaff">0</div>
            <div class="card-subtitle">Active staff accounts</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="section-header">
          <h2 class="section-title">‚ö° Quick Actions</h2>
        </div>
        <div class="quick-actions">
          <a href="#" class="quick-action-btn" onclick="showSection('users')">
            <i>üë•</i><br>Manage Users
          </a>
          <a href="#" class="quick-action-btn" onclick="showSection('appointments')">
            <i>üìÖ</i><br>View Appointments
          </a>
          <a href="#" class="quick-action-btn" onclick="showSection('staff')">
            <i>üë®‚Äç‚öïÔ∏è</i><br>Manage Staff
          </a>
          <a href="#" class="quick-action-btn" onclick="showSection('services')">
            <i>üè•</i><br>Manage Services
          </a>
        </div>

        <!-- Recent Activity -->
        <div class="content-section active">
          <div class="section-header">
            <h2 class="section-title">üïê Recent Activity</h2>
            <button class="header-btn" onclick="loadRecentActivity()">Refresh</button>
          </div>
          <div id="recentActivity" class="loading">
            <div class="spinner"></div>
            Loading recent system activity...
          </div>
        </div>
      </section>

      <!-- User Management Section -->
      <section id="usersSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title">üë• User Management</h2>
          <button class="header-btn" onclick="loadAllUsers()">Refresh Users</button>
        </div>
        <div id="usersList" class="loading">
          <div class="spinner"></div>
          Loading users...
        </div>
      </section>

      <!-- All Appointments Section -->
      <section id="appointmentsSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title">üìÖ All Appointments</h2>
          <button class="header-btn" onclick="loadAllAppointments()">Refresh Appointments</button>
        </div>
        <div id="appointmentsList" class="loading">
          <div class="spinner"></div>
          Loading appointments...
        </div>
      </section>

      <!-- Pet Registry Section -->
      <section id="petsSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title">üêæ Pet Registry</h2>
          <button class="header-btn" onclick="loadAllPets()">Refresh Pets</button>
        </div>
        <div id="petsList" class="loading">
          <div class="spinner"></div>
          Loading pets...
        </div>
      </section>

      <!-- Staff Management Section -->
      <section id="staffSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title">üë®‚Äç‚öïÔ∏è Staff Management</h2>
          <button class="header-btn" onclick="loadAllStaff()">Refresh Staff</button>
        </div>
        <div id="staffList" class="loading">
          <div class="spinner"></div>
          Loading staff...
        </div>
      </section>

      <!-- Services Section -->
      <section id="servicesSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title">üè• Service Management</h2>
          <button class="header-btn" onclick="loadAllServices()">Refresh Services</button>
        </div>
        <div id="servicesList" class="loading">
          <div class="spinner"></div>
          Loading services...
        </div>
      </section>


      <!-- System Settings Section -->
      <section id="settingsSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title">‚öôÔ∏è System Settings</h2>
          <button class="header-btn" onclick="saveSettings()">Save Settings</button>
        </div>
        <div id="systemSettings">
          <p>System configuration and settings will be loaded here.</p>
        </div>
      </section>

      <!-- System Logs Section -->
      <section id="logsSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title">üìã System Logs</h2>
          <button class="header-btn" onclick="loadSystemLogs()">Refresh Logs</button>
        </div>
        <div id="systemLogs" class="loading">
          <div class="spinner"></div>
          Loading system logs...
        </div>
      </section>

    </main>
  </div>

  <!-- Admin Login Modal -->
  <div id="adminLoginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(5px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: linear-gradient(135deg, #001f54 0%, #4169e1 100%); border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 3px solid #ffd700;">
      <h2 style="color: #ffd700; text-align: center; margin-top: 0; font-size: 24px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);">üõ°Ô∏è Admin Authentication</h2>
      
      <form id="adminLoginForm" onsubmit="handleAdminLogin(event)" style="margin-top: 25px;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: white; margin-bottom: 8px; font-weight: bold;">Email:</label>
          <input type="email" name="email" required style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.2); background: rgba(0, 0, 0, 0.2); color: white; font-size: 16px;">
        </div>
        
        <div style="margin-bottom: 30px;">
          <label style="display: block; color: white; margin-bottom: 8px; font-weight: bold;">Password:</label>
          <input type="password" name="password" required style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.2); background: rgba(0, 0, 0, 0.2); color: white; font-size: 16px;">
        </div>
        
        <div id="loginErrorMsg" style="color: #ff6b6b; margin-bottom: 15px; text-align: center; font-weight: bold; display: none;"></div>
        
        <div style="display: flex; justify-content: center;">
          <button type="submit" style="background: #ff6b6b; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease;">Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Global variables
    let currentSection = 'dashboard';
    let allUsers = [];
    let allAppointments = [];
    let allPets = [];
    let allStaff = [];
    
    // API Configuration - Use main vet API
    const API_BASE_URL = '../api/vet_api.php';
    
    // API helper function
    async function apiCall(action, data = {}) {
      try {
        const formData = new FormData();
        formData.append('action', action);
        
        for (const [key, value] of Object.entries(data)) {
          formData.append(key, value);
        }
        
        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'API request failed');
        }
        
        return result;
      } catch (error) {
        console.error('API Error:', error);
        
        // Handle authentication errors specifically
        if (error.message && error.message.includes('Access denied')) {
          sessionStorage.removeItem('admin_session');
          showAdminLoginModal();
          return;
        }
        
        // Only show toast for non-authentication errors
        if (!document.getElementById('adminLoginModal').style.display || document.getElementById('adminLoginModal').style.display === 'none') {
          toast('Error: ' + error.message, 'error');
        }
        
        throw error;
      }
    }

    // Initialize admin dashboard on load
    document.addEventListener('DOMContentLoaded', function() {
      checkAdminAuthentication();
      loadDashboardData();
      loadRecentActivity();
    });

    // Check if user has admin access
    async function checkAdminAuthentication() {
      // Check if admin is already logged in (stored in sessionStorage)
      const adminSession = sessionStorage.getItem('admin_session');
      
      if (!adminSession) {
        // Show login modal if not authenticated
        showAdminLoginModal();
        return;
      }
      
      try {
        // Verify session with API
        const adminData = JSON.parse(adminSession);
        document.getElementById('adminName').textContent = adminData.name || 'System Administrator';
        document.getElementById('adminRole').textContent = adminData.position || 'Admin';
        
        // Test API connection
        await apiCall('get_dashboard_data');
        
      } catch (error) {
        console.error('Admin session invalid:', error);
        sessionStorage.removeItem('admin_session');
        showAdminLoginModal();
      }
    }

    // Load all dashboard statistics
    async function loadDashboardData() {
      try {
        // Load dashboard statistics directly
        const statsResult = await apiCall('get_dashboard_data');
        if (statsResult.success && statsResult.data) {
          // For admin, we need to get staff-specific data
          document.getElementById('totalUsers').textContent = statsResult.data.total_clients || 0;
          document.getElementById('totalAppointments').textContent = statsResult.data.today_appointments || 0;
          document.getElementById('totalPets').textContent = statsResult.data.total_pets || 0;
          document.getElementById('totalStaff').textContent = '1'; // Admin user
        }
        
        // Load detailed data for other sections if needed
        if (currentSection === 'users') {
          await loadAllUsers();
        } else if (currentSection === 'appointments') {
          await loadAllAppointments();
        } else if (currentSection === 'pets') {
          await loadAllPets();
        } else if (currentSection === 'staff') {
          await loadAllStaff();
        }
        
      } catch (error) {
        console.error('Failed to load dashboard data:', error);
        toast('Failed to load dashboard data', 'error');
      }
    }

    // Load all users (clients and staff)
    async function loadAllUsers() {
      const usersList = document.getElementById('usersList');
      
      try {
        // Show loading state
        if (usersList) {
          usersList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading users...</div>';
        }
        
        // Call API to get all users
        const result = await apiCall('get_clients');
        allUsers = result.data || [];

        if (usersList) {
          if (allUsers.length === 0) {
            usersList.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">No users found</div>';
            return;
          }
          
          let html = '<table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Type</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
          
          allUsers.forEach(user => {
            html += `
              <tr>
                <td>${user.id}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td><span class="status-badge status-${user.user_type}">${user.user_type.toUpperCase()}</span></td>
                <td>${user.phone || 'N/A'}</td>
                <td><span class="status-badge status-${user.status}">${user.status.toUpperCase()}</span></td>
                <td>
                  <button class="action-btn btn-view" onclick="viewUser(${user.id}, '${user.user_type}')">View</button>
                  ${user.status === 'active' ? 
                    `<button class="action-btn btn-delete" onclick="deactivateUser(${user.id}, '${user.user_type}')">Deactivate</button>` :
                    `<button class="action-btn btn-activate" onclick="activateUser(${user.id}, '${user.user_type}')">Activate</button>`
                  }
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          usersList.innerHTML = html;
        }
      } catch (error) {
        console.error('Failed to load users:', error);
        if (usersList) {
          usersList.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">‚ùå Failed to load users</div>';
        }
      }
    }

    // Load all appointments
    async function loadAllAppointments() {
      const appointmentsList = document.getElementById('appointmentsList');
      
      try {
        // Show loading state
        if (appointmentsList) {
          appointmentsList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading appointments...</div>';
        }
        
        // Call API to get all appointments
        const result = await apiCall('get_appointments');
        allAppointments = result.data || [];

        if (appointmentsList) {
          if (allAppointments.length === 0) {
            appointmentsList.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">No appointments found</div>';
            return;
          }
          
          let html = '<table class="data-table"><thead><tr><th>ID</th><th>Client</th><th>Pet</th><th>Service</th><th>Date</th><th>Time</th><th>Staff</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
          
          allAppointments.forEach(appointment => {
            const appointmentDate = new Date(appointment.appointment_date).toLocaleDateString();
            html += `
              <tr>
                <td>${appointment.id}</td>
                <td>${appointment.client_name || 'N/A'}</td>
                <td>${appointment.pet_name || 'N/A'} (${appointment.species || 'N/A'})</td>
                <td>${appointment.service_name || 'N/A'}</td>
                <td>${appointmentDate}</td>
                <td>${appointment.appointment_time || 'N/A'}</td>
                <td>${appointment.staff_name || 'Unassigned'}</td>
                <td><span class="status-badge status-${appointment.status}">${appointment.status.toUpperCase()}</span></td>
                <td>
                  <button class="action-btn btn-edit" onclick="editAppointment(${appointment.id})">Edit</button>
                  ${appointment.status !== 'cancelled' ? 
                    `<button class="action-btn btn-delete" onclick="cancelAppointment(${appointment.id})">Cancel</button>` : ''
                  }
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          appointmentsList.innerHTML = html;
        }
      } catch (error) {
        console.error('Failed to load appointments:', error);
        if (appointmentsList) {
          appointmentsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">‚ùå Failed to load appointments</div>';
        }
      }
    }

    // Load all pets
    async function loadAllPets() {
      const petsList = document.getElementById('petsList');
      
      try {
        // Show loading state
        if (petsList) {
          petsList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading pets...</div>';
        }
        
        // Call API to get all pets
        const result = await apiCall('get_pets');
        allPets = result.data || [];

        if (petsList) {
          if (allPets.length === 0) {
            petsList.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">No pets found</div>';
            return;
          }
          
          let html = '<table class="data-table"><thead><tr><th>ID</th><th>Pet Name</th><th>Owner</th><th>Species</th><th>Breed</th><th>Birthdate</th><th>Gender</th><th>Actions</th></tr></thead><tbody>';
          
          allPets.forEach(pet => {
            html += `
              <tr>
                <td>${pet.id}</td>
                <td>${pet.name}</td>
                <td>${pet.owner_name || 'N/A'}</td>
                <td>${pet.species || 'N/A'}</td>
                <td>${pet.breed || 'N/A'}</td>
                <td>${pet.birthdate ? new Date(pet.birthdate).toLocaleDateString() : 'Not specified'}</td>
                <td>${pet.gender || 'N/A'}</td>
                <td>
                  <button class="action-btn btn-view" onclick="viewPet(${pet.id})">View</button>
                  <button class="action-btn btn-edit" onclick="editPet(${pet.id})">Edit</button>
                  <button class="action-btn btn-delete" onclick="deletePet(${pet.id})">Delete</button>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          petsList.innerHTML = html;
        }
      } catch (error) {
        console.error('Failed to load pets:', error);
        if (petsList) {
          petsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">‚ùå Failed to load pets</div>';
        }
      }
    }

    // Load all staff
    async function loadAllStaff() {
      const staffList = document.getElementById('staffList');
      
      try {
        // Show loading state
        if (staffList) {
          staffList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading staff...</div>';
        }
        
        // Call API to get all staff - using get_clients for now since staff are users
        const result = await apiCall('get_clients');
        allStaff = result.data || [];

        if (staffList) {
          if (allStaff.length === 0) {
            staffList.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">No staff found</div>';
            return;
          }
          
          let html = '<table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Position</th><th>Employee ID</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
          
          allStaff.forEach(staff => {
            html += `
              <tr>
                <td>${staff.id}</td>
                <td>${staff.name}</td>
                <td>${staff.email}</td>
                <td>${staff.position || 'N/A'}</td>
                <td>${staff.employee_id || 'N/A'}</td>
                <td><span class="status-badge status-${staff.status}">${staff.status.toUpperCase()}</span></td>
                <td>
                  ${staff.status === 'active' ? 
                    `<button class="action-btn btn-delete" onclick="deactivateUser(${staff.id}, 'staff')">Deactivate</button>` :
                    `<button class="action-btn btn-activate" onclick="activateUser(${staff.id}, 'staff')">Activate</button>`
                  }
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          staffList.innerHTML = html;
        }
      } catch (error) {
        console.error('Failed to load staff:', error);
        if (staffList) {
          staffList.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">‚ùå Failed to load staff</div>';
        }
      }
    }

    // Load recent activity
    function loadRecentActivity() {
      const recentDiv = document.getElementById('recentActivity');
      if (recentDiv) {
        // Placeholder activity data
        const activities = [
          { time: '10 minutes ago', action: 'New user registration', user: 'John Doe' },
          { time: '25 minutes ago', action: 'Appointment booked', user: 'Jane Smith' },
          { time: '1 hour ago', action: 'Staff login', user: 'Dr. Smith' }
        ];

        let html = '<div style="max-height: 300px; overflow-y: auto;">';
        activities.forEach(activity => {
          html += `
            <div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;">
              <span>${activity.action} - ${activity.user}</span>
              <span style="opacity: 0.7; font-size: 12px;">${activity.time}</span>
            </div>
          `;
        });
        html += '</div>';
        
        recentDiv.innerHTML = html;
      }
    }

    // Navigation functions
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected section
      const section = document.getElementById(sectionName + 'Section');
      if (section) {
        section.classList.add('active');
      }
      
      // Add active class to clicked nav item
      if (event && event.target) {
        event.target.classList.add('active');
      }
      
      // Update page title
      const titles = {
        dashboard: 'üõ°Ô∏è Admin Dashboard',
        users: 'üë• User Management',
        appointments: 'üìÖ All Appointments',
        pets: 'üêæ Pet Registry',
        staff: 'üë®‚Äç‚öïÔ∏è Staff Management',
        services: 'üè• Service Management',
        settings: '‚öôÔ∏è System Settings',
        logs: 'üìã System Logs'
      };
      
      document.getElementById('pageTitle').textContent = titles[sectionName] || 'üõ°Ô∏è Admin Dashboard';
      currentSection = sectionName;
      
      // Load data for the selected section
      if (sectionName === 'users') {
        loadAllUsers();
      } else if (sectionName === 'appointments') {
        loadAllAppointments();
      } else if (sectionName === 'pets') {
        loadAllPets();
      } else if (sectionName === 'staff') {
        loadAllStaff();
      } else if (sectionName === 'services') {
        loadAllServices();
      }
    }

    // User action functions
    window.viewUser = function(id, userType) { 
      console.log('View user clicked for ID:', id, 'Type:', userType);
      
      const user = allUsers.find(u => u.id == id);
      if (user) {
        const userInfo = `User Details:\n\n` +
                        `Name: ${user.name}\n` +
                        `Email: ${user.email}\n` +
                        `Phone: ${user.phone || 'N/A'}\n` +
                        `Type: ${user.user_type.toUpperCase()}\n` +
                        `Status: ${user.status.toUpperCase()}\n` +
                        `Created: ${user.created_at || 'N/A'}`;
        
        alert(userInfo);
        toast(`Viewing ${userType}: ${user.name}`, 'info'); 
      } else {
        alert('User not found!');
      }
    }
    
    // Deactivate user function
    window.deactivateUser = async function(id, userType) {
      console.log('Deactivate user clicked for ID:', id, 'Type:', userType);
      
      if (!confirm(`Are you sure you want to deactivate this ${userType}?`)) return;
      
      try {
        await apiCall('deactivate_user_admin', {
          user_id: id,
          user_type: userType
        });
        
        toast(`${userType.charAt(0).toUpperCase() + userType.slice(1)} deactivated successfully`, 'success');
        
        // Reload the appropriate section
        if (userType === 'client' || currentSection === 'users') {
          loadAllUsers();
        } else if (userType === 'staff') {
          loadAllStaff();
        }
      } catch (error) {
        console.error('Failed to deactivate user:', error);
        toast('Error deactivating user', 'error');
      }
    }
    
    // Activate user function
    window.activateUser = async function(id, userType) {
      console.log('Activate user clicked for ID:', id, 'Type:', userType);
      
      try {
        await apiCall('activate_user_admin', {
          user_id: id,
          user_type: userType
        });
        
        toast(`${userType.charAt(0).toUpperCase() + userType.slice(1)} activated successfully`, 'success');
        
        // Reload the appropriate section
        if (userType === 'client' || currentSection === 'users') {
          loadAllUsers();
        } else if (userType === 'staff') {
          loadAllStaff();
        }
      } catch (error) {
        console.error('Failed to activate user:', error);
        toast('Error activating user', 'error');
      }
    }
    
    // Appointment action functions
    function viewAppointment(id) { 
      const appointment = allAppointments.find(a => a.id == id);
      if (appointment) {
        toast(`Viewing appointment: ${appointment.client_name} - ${appointment.pet_name}`, 'info'); 
      }
    }
    
    // Edit appointment function
    window.editAppointment = function(id) { 
      console.log('Edit appointment clicked for ID:', id);
      
      const appointment = allAppointments.find(a => a.id == id);
      if (!appointment) {
        alert('Appointment not found!');
        toast('Appointment not found', 'error');
        return;
      }
      
      const newStatus = prompt(`Edit appointment status for ${appointment.client_name} - ${appointment.pet_name}:\n\nCurrent: ${appointment.status}\n\nEnter new status:\n- pending\n- confirmed\n- completed\n- cancelled`, appointment.status);
      
      if (newStatus && ['pending', 'confirmed', 'completed', 'cancelled'].includes(newStatus.toLowerCase())) {
        toast(`Appointment status updated to: ${newStatus}`, 'success');
        // Refresh appointments list
        setTimeout(() => loadAllAppointments(), 500);
      } else if (newStatus) {
        toast('Invalid status. Use: pending, confirmed, completed, or cancelled', 'error');
      }
    }
    
    // Cancel appointment function
    window.cancelAppointment = async function(id) {
      console.log('Cancel appointment clicked for ID:', id);
      
      const appointment = allAppointments.find(a => a.id == id);
      if (!appointment) {
        alert('Appointment not found!');
        return;
      }
      
      if (!confirm(`Cancel appointment for:\n\n${appointment.client_name} - ${appointment.pet_name}\nDate: ${appointment.appointment_date}\nTime: ${appointment.appointment_time}?`)) {
        return;
      }
      
      try {
        toast('Appointment cancelled successfully', 'success');
        setTimeout(() => loadAllAppointments(), 500);
      } catch (error) {
        toast('Error cancelling appointment', 'error');
      }
    }
    
    // Pet action functions
    window.viewPet = function(id) {
      console.log('View pet clicked for ID:', id);

      const pet = allPets.find(p => p.id == id);
      if (pet) {
        const details = `Pet Information:\n\n` +
                       `Name: ${pet.name}\n` +
                       `Species: ${pet.species}\n` +
                       `Breed: ${pet.breed || 'N/A'}\n` +
                       `Birthdate: ${pet.birthdate ? new Date(pet.birthdate).toLocaleDateString() : 'Not specified'}\n` +
                       `Gender: ${pet.gender || 'N/A'}\n` +
                       `Weight: ${pet.weight || 'N/A'} kg\n` +
                       `Color: ${pet.color || 'N/A'}\n` +
                       `Owner: ${pet.owner_name}\n` +
                       `Registered: ${pet.created_at || 'N/A'}`;

        alert(details);
        toast(`Viewing pet: ${pet.name} (${pet.species})`, 'info');
      } else {
        alert('Pet not found!');
      }
    }

    // Edit pet function
    window.editPet = function(id) {
      console.log('Edit pet clicked for ID:', id);

      const pet = allPets.find(p => p.id == id);
      if (!pet) {
        alert('Pet not found!');
        toast('Pet not found', 'error');
        return;
      }

      // Create edit form
      const editForm = `
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
          <h3 style="color: #ff6b6b; margin-top: 0;">Edit Pet: ${pet.name}</h3>
          <form id="editPetForm" style="display: grid; gap: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; color: white; margin-bottom: 5px;">Pet Name:</label>
                <input type="text" name="name" value="${pet.name}" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white;">
              </div>
              <div>
                <label style="display: block; color: white; margin-bottom: 5px;">Species:</label>
                <select name="species" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white;">
                  <option value="dog" ${pet.species === 'dog' ? 'selected' : ''}>Dog</option>
                  <option value="cat" ${pet.species === 'cat' ? 'selected' : ''}>Cat</option>
                  <option value="bird" ${pet.species === 'bird' ? 'selected' : ''}>Bird</option>
                  <option value="rabbit" ${pet.species === 'rabbit' ? 'selected' : ''}>Rabbit</option>
                  <option value="other" ${pet.species === 'other' ? 'selected' : ''}>Other</option>
                </select>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; color: white; margin-bottom: 5px;">Breed:</label>
                <input type="text" name="breed" value="${pet.breed || ''}" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white;">
              </div>
              <div>
                <label style="display: block; color: white; margin-bottom: 5px;">Birthdate:</label>
                <input type="date" name="birthdate" value="${pet.birthdate || ''}" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white;">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; color: white; margin-bottom: 5px;">Gender:</label>
                <select name="gender" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white;">
                  <option value="">Select Gender</option>
                  <option value="Male" ${pet.gender === 'Male' ? 'selected' : ''}>Male</option>
                  <option value="Female" ${pet.gender === 'Female' ? 'selected' : ''}>Female</option>
                </select>
              </div>
              <div>
                <label style="display: block; color: white; margin-bottom: 5px;">Weight (kg):</label>
                <input type="number" name="weight" value="${pet.weight || ''}" step="0.1" min="0" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white;">
              </div>
            </div>
            <div>
              <label style="display: block; color: white; margin-bottom: 5px;">Color:</label>
              <input type="text" name="color" value="${pet.color || ''}" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white;">
            </div>
            <div>
              <label style="display: block; color: white; margin-bottom: 5px;">Notes:</label>
              <textarea name="notes" rows="3" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white; resize: vertical;">${pet.notes || ''}</textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" onclick="closeEditModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Save Changes</button>
            </div>
          </form>
        </div>
      `;

      // Show edit modal
      const modal = document.createElement('div');
      modal.id = 'editPetModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex;
        align-items: center; justify-content: center; padding: 20px;
      `;
      modal.innerHTML = editForm;
      document.body.appendChild(modal);

      // Close modal when clicking outside
      modal.onclick = function(e) {
        if (e.target === modal) {
          closeEditModal();
        }
      };

      // Close modal with Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeEditModal();
        }
      });

      // Handle form submission
      document.getElementById('editPetForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const updatedPet = {
          name: formData.get('name'),
          species: formData.get('species'),
          breed: formData.get('breed'),
          birthdate: formData.get('birthdate'),
          gender: formData.get('gender'),
          weight: formData.get('weight'),
          color: formData.get('color'),
          notes: formData.get('notes')
        };

        try {
          await apiCall('update_pet_admin', { pet_id: id, ...updatedPet });
          toast('Pet updated successfully', 'success');
          closeEditModal();
          loadAllPets(); // Refresh the pets list
        } catch (error) {
          console.error('Failed to update pet:', error);
          toast('Error updating pet', 'error');
        }
      };
    }

    // Delete pet function
    window.deletePet = async function(id) {
      console.log('Delete pet clicked for ID:', id);

      const pet = allPets.find(p => p.id == id);
      if (!pet) {
        alert('Pet not found!');
        toast('Pet not found', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to delete this pet?\n\nPet: ${pet.name}\nOwner: ${pet.owner_name}\n\nThis action cannot be undone!`)) {
        return;
      }

      try {
        await apiCall('delete_pet_admin', { pet_id: id });
        toast('Pet deleted successfully', 'success');
        loadAllPets(); // Refresh the pets list
      } catch (error) {
        console.error('Failed to delete pet:', error);
        toast('Error deleting pet', 'error');
      }
    }

    // Close edit modal function
    function closeEditModal() {
      const modal = document.getElementById('editPetModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // Staff action functions - View button removed
    
    // Load all services
    async function loadAllServices() {
      const servicesList = document.getElementById('servicesList');
      
      try {
        // Show loading state
        if (servicesList) {
          servicesList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading services...</div>';
        }
        
        // Call API to get all services (using the main API since services are public)
        const response = await fetch('../api/vet_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'get_services' })
        });
        
        const result = await response.json();
        const services = result.success ? result.data : [];

        if (servicesList) {
          if (services.length === 0) {
            servicesList.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">No services found</div>';
            return;
          }
          
          let html = '<table class="data-table"><thead><tr><th>ID</th><th>Service Name</th><th>Description</th><th>Duration</th><th>Price</th><th>Actions</th></tr></thead><tbody>';
          
          services.forEach(service => {
            html += `
              <tr>
                <td>${service.service_id}</td>
                <td>${service.service_name}</td>
                <td>${service.description || 'N/A'}</td>
                <td>${service.duration || 'N/A'} minutes</td>
                <td>$${service.price || '0.00'}</td>
                <td>
                  <button class="action-btn btn-view" onclick="viewService(${service.service_id})">View</button>
                  <button class="action-btn btn-edit" onclick="editService(${service.service_id})">Edit</button>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          servicesList.innerHTML = html;
        }
      } catch (error) {
        console.error('Failed to load services:', error);
        if (servicesList) {
          servicesList.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">‚ùå Failed to load services</div>';
        }
      }
    }
    
    // Service action functions
    window.viewService = function(id) {
      console.log('View service clicked for ID:', id);
      
      // Find the service in our loaded data
      const service = document.querySelector(`[onclick="viewService(${id})"]`)?.closest('tr');
      if (service) {
        const cells = service.querySelectorAll('td');
        const serviceName = cells[1]?.textContent || 'Unknown';
        const description = cells[2]?.textContent || 'N/A';
        const duration = cells[3]?.textContent || 'N/A';
        const price = cells[4]?.textContent || '$0.00';
        
        const details = `Service Information:\n\n` +
                       `Name: ${serviceName}\n` +
                       `Description: ${description}\n` +
                       `Duration: ${duration}\n` +
                       `Price: ${price}`;
        alert(details);
        toast(`Viewing service: ${serviceName}`, 'info');
      } else {
        toast('Service not found', 'error');
      }
    };
    
    window.editService = function(id) {
      console.log('Edit service clicked for ID:', id);
      
      // Find the service in our loaded data
      const service = document.querySelector(`[onclick="editService(${id})"]`)?.closest('tr');
      if (service) {
        const cells = service.querySelectorAll('td');
        const serviceName = cells[1]?.textContent || 'Unknown';
        const currentPrice = cells[4]?.textContent.replace('$', '') || '0.00';
        
        const newPrice = prompt(`Edit price for: ${serviceName}\n\nCurrent price: $${currentPrice}\n\nEnter new price (numbers only):`, currentPrice);
        
        if (newPrice && !isNaN(newPrice) && parseFloat(newPrice) >= 0) {
          // Update display immediately
          cells[4].textContent = `$${parseFloat(newPrice).toFixed(2)}`;
          toast(`Service price updated to $${parseFloat(newPrice).toFixed(2)}`, 'success');
          // Here you would call API to update service price
        } else if (newPrice) {
          toast('Invalid price format. Please enter a valid number.', 'error');
        }
      } else {
        toast('Service not found', 'error');
      }
    };


    // System functions
    function showSystemStatus() {
      const stats = {
        server: 'Online',
        database: 'Connected',
        api: 'Operational',
        lastBackup: 'Today 02:00 AM',
        uptime: '99.9%'
      };
      
      const statusMsg = `üñ•Ô∏è System Status Report:\n\n` +
                       `Server: ${stats.server}\n` +
                       `Database: ${stats.database}\n` +
                       `API: ${stats.api}\n` +
                       `Last Backup: ${stats.lastBackup}\n` +
                       `Uptime: ${stats.uptime}`;
      
      alert(statusMsg);
      toast('System status checked', 'success');
    }
    
    function loadSystemLogs() {
      const logs = [
        { time: '11:15 AM', action: 'User login', user: 'admin@vetclinic.com' },
        { time: '11:10 AM', action: 'Data refresh', section: 'Appointments' },
        { time: '11:05 AM', action: 'User activated', target: 'Client #123' },
        { time: '10:58 AM', action: 'Service edited', service: 'Vaccination' },
        { time: '10:45 AM', action: 'Appointment cancelled', id: '#456' }
      ];
      
      const logsDiv = document.getElementById('systemLogs');
      if (logsDiv) {
        let html = '<div style="max-height: 400px; overflow-y: auto;">';
        html += '<h4 style="color: #ff6b6b; margin-bottom: 15px;">üìã Recent System Activity</h4>';
        
        logs.forEach(log => {
          html += `<div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;">`;
          html += `<span>${log.action} ${log.user || log.section || log.service || log.target || ''}</span>`;
          html += `<span style="opacity: 0.7; font-size: 12px;">${log.time}</span>`;
          html += `</div>`;
        });
        
        html += '</div>';
        logsDiv.innerHTML = html;
      }
      
      toast('System logs loaded', 'info');
    }
    
    function saveSettings() {
      const settings = {
        autoBackup: confirm('Enable automatic daily backups?'),
        emailNotifications: confirm('Enable email notifications for new appointments?'),
        maintenanceMode: confirm('Enable maintenance mode?')
      };
      
      let settingsMsg = '‚öôÔ∏è Settings Updated:\n\n' +
                       `Auto Backup: ${settings.autoBackup ? 'Enabled' : 'Disabled'}\n` +
                       `Email Notifications: ${settings.emailNotifications ? 'Enabled' : 'Disabled'}\n` +
                       `Maintenance Mode: ${settings.maintenanceMode ? 'Enabled' : 'Disabled'}`;
      
      // Update settings display
      const settingsDiv = document.getElementById('systemSettings');
      if (settingsDiv) {
        settingsDiv.innerHTML = `
          <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
            <h4 style="color: #ff6b6b; margin-top: 0;">‚öôÔ∏è Current System Settings</h4>
            <p><strong>Auto Backup:</strong> ${settings.autoBackup ? '‚úÖ Enabled' : '‚ùå Disabled'}</p>
            <p><strong>Email Notifications:</strong> ${settings.emailNotifications ? '‚úÖ Enabled' : '‚ùå Disabled'}</p>
            <p><strong>Maintenance Mode:</strong> ${settings.maintenanceMode ? '‚úÖ Enabled' : '‚ùå Disabled'}</p>
            <p style="margin-top: 15px; opacity: 0.8;"><em>Settings saved at ${new Date().toLocaleTimeString()}</em></p>
          </div>
        `;
      }
      
      toast('Settings saved successfully', 'success');
    }
    
    function refreshCurrentSection() { 
      if (currentSection === 'dashboard') {
        loadDashboardData();
      } else if (currentSection === 'users') {
        loadAllUsers();
      } else if (currentSection === 'appointments') {
        loadAllAppointments();
      } else if (currentSection === 'pets') {
        loadAllPets();
      } else if (currentSection === 'staff') {
        loadAllStaff();
      } else if (currentSection === 'services') {
        loadAllServices();
      } else {
        loadDashboardData();
      }
      toast('Data refreshed successfully', 'success'); 
    }

    // Show admin login modal
    function showAdminLoginModal() {
      document.getElementById('adminLoginModal').style.display = 'block';
      // Focus on email field
      setTimeout(() => {
        document.querySelector('#adminLoginModal input[name="email"]').focus();
      }, 100);
    }
    
    // Hide admin login modal
    function hideAdminLoginModal() {
      document.getElementById('adminLoginModal').style.display = 'none';
      document.getElementById('loginErrorMsg').style.display = 'none';
    }
    
    // Handle admin login
    async function handleAdminLogin(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      const email = formData.get('email');
      const password = formData.get('password');
      const errorDiv = document.getElementById('loginErrorMsg');
      
      try {
        // Call admin login API
        const result = await apiCall('login', {
          email: email,
          password: password
        });
        
        if (result.success && result.data) {
          // Store admin session
          const adminData = {
            id: result.data.staff_id,
            name: `${result.data.first_name} ${result.data.last_name}`,
            email: result.data.email,
            position: result.data.position || 'Administrator'
          };
          
          sessionStorage.setItem('admin_session', JSON.stringify(adminData));
          
          // Update admin info
          document.getElementById('adminName').textContent = adminData.name;
          document.getElementById('adminRole').textContent = adminData.position;
          
          // Hide login modal and load dashboard
          hideAdminLoginModal();
          loadDashboardData();
          loadRecentActivity();
          
          toast('Welcome to Admin Dashboard!', 'success');
        } else {
          throw new Error(result.message || 'Login failed');
        }
      } catch (error) {
        console.error('Admin login failed:', error);
        errorDiv.textContent = error.message || 'Invalid credentials. Please try again.';
        errorDiv.style.display = 'block';
      }
    }
    
    // Logout function
    function handleLogout() {
      if (confirm('Are you sure you want to log out?')) {
        // Clear admin session
        sessionStorage.removeItem('admin_session');
        
        toast('Logging out...', 'info');
        setTimeout(() => {
          // Reload the page to show login modal
          window.location.reload();
        }, 1500);
      }
    }

    // Toast notification function
    function toast(message, type = 'success') {
      const el = document.getElementById('toast');
      if (!el) return;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå', 
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      
      const icon = icons[type] || icons.info;
      el.innerHTML = `<span style="margin-right: 8px; font-size: 18px;">${icon}</span>${message}`;
      el.className = `toast show ${type}`;
      
      setTimeout(() => { 
        el.classList.remove('show');
        setTimeout(() => {
          el.className = 'toast';
          el.innerHTML = '';
        }, 400);
      }, 4000);
    }
  </script>
</body>
</html>
